function loadUrl(a,b){a=a+"?t="+(new Date).getTime();var c;try{c=new XMLHttpRequest}catch(d){try{c=new ActiveXObject("Msxml2.XMLHTTP")}catch(d){try{c=new ActiveXObject("Microsoft.XMLHTTP")}catch(d){b({})}}}c.onreadystatechange=function(){if(4==c.readyState){var a=JSON.parse(c.responseText);b(a)}},c.open("GET",a,!0),c.send()}function random(){var a=1e4*Math.sin(randomSeed++);return a-Math.floor(a)}function Maybe(a,b){isNaN(b)&&(b=1),random()<=b&&a()}function typeOf(a){var b=typeof a;return"object"===b&&(a?a instanceof Array&&(b="array"):b="null"),b}function isArray(a){return"array"==typeOf(a)}function isBoolean(a){return"boolean"==typeOf(a)}function isFunction(a){return"function"==typeOf(a)}function isDefined(a){return"undefined"!=typeOf(a)}function isNumeric(a){return!isNaN(a)}function sortByKey(a,b){return a.sort(function(a,c){var d=a[b],e=c[b];return e>d?-1:d>e?1:0})}var Game=function(){function a(){var b=l.originalViewPortWidth*l.tileSize,c=l.originalViewPortHeight*l.tileSize,d=window.innerHeight/window.innerWidth;switch(l.scaling){case SCALING.FIT_WIDTH:c=d*b;break;case SCALING.FIT_HEIGHT:d=window.innerWidth/window.innerHeight,b=d*c;break;case SCALING.CONTAIN:var e=Math.ceil(d*b/l.tileSize);l.originalViewPortHeight>e?(d=window.innerWidth/window.innerHeight,b=d*c):c=d*b}if(l.viewPortWidth=Math.ceil(b/l.tileSize),l.viewPortHeight=Math.ceil(c/l.tileSize),l.canvasWidth=b,l.canvasHeight=c,canvas.width=b,canvas.height=c,o&&o.setPosition(),C.left=0,C.top=0,C.hintTop=0,C.hintLeft=150,l.showFPS&&(C.left=200,C.hintLeft=350,400>b&&(C.left=0,C.top=24,C.hintLeft=0,C.hintTop=48)),navigator.isCocoonJS)UI.setScale(1,1);else{ctx.webkitImageSmoothingEnabled=ctx.imageSmoothingEnabled=ctx.mozImageSmoothingEnabled=ctx.oImageSmoothingEnabled=!1,canvas.style.width=window.innerWidth+"px",canvas.style.height=window.innerHeight+"px";var f=parseInt(canvas.style.width)/canvas.width,g=parseInt(canvas.style.height)/canvas.height;UI.setScale(f,g)}Map.onResize(l),UI.onResize(l),window.addEventListener("resize",a,!1)}function b(a){var d=a-q;d>v&&(c(),k=1e3/(a-q),q=a),j=1e3/(a-r),r=a,l.showScore&&g(),l.showFPS&&f(),l.showHint&&h(),requestAnimFrame(b)}function c(){D()}function d(){w++,w>=t&&(w=0),Map.process(w),e(w),Map.cleanUp()}function e(a){ctx.fillStyle=m,ctx.fillRect(0,0,canvas.width,canvas.height),n&&ctx.drawImage(n,0,0),Map.render(a),UI.renderElements()}function f(){var a=0;if(!isNaN(k)){u.push(k),u.length>60&&u.shift();for(var b=0,c=0;u.length>c;c++)b+=u[c];a=Math.round(b/u.length)}ctx.fillStyle="Black",ctx.fillRect(0,0,200,24),ctx.fillStyle="White",ctx.font="normal 10pt Arial",ctx.fillText(Math.round(j)+" frames/s , "+Math.round(k)+" ticks/s + ("+a+")",10,16)}function g(){ctx.fillStyle="Black",ctx.fillRect(C.left,C.top,200,24),ctx.fillStyle="White",ctx.font="normal 10pt Arial",ctx.fillText("Score: "+x,C.left+10,C.top+16),ctx.fillText("Needed: "+z,C.left+80,C.top+16)}function h(){ctx.fillStyle="Black",ctx.fillRect(C.hintLeft,C.hintTop,200,24),ctx.fillStyle="White",ctx.font="normal 10pt Arial",ctx.fillText(y,C.hintLeft+10,C.hintTop+16)}var i,j,k,l,m,n,o,p={},q=0,r=0,s=35,t=4,u=[],v=1e3/s,w=-1,x=0,y="Good luck!",z=0,A=!1,B=!1,C={top:0,left:0},D=function(){};p.init=function(b){l=b;var c=(new Date).getTime();if(l.seed=c,canvas=document.createElement("canvas"),ctx=canvas.getContext("2d"),b.scaling)l.originalViewPortWidth=b.viewPortWidth,l.originalViewPortHeight=b.viewPortHeight,a();else{var d=b.viewPortWidth*b.tileSize,e=b.viewPortHeight*b.tileSize;canvas.width=d,canvas.height=e}document.body.appendChild(canvas),i=b.tileSize,b.borderScrollOffset=8;var f=[{id:"spritesheet",url:b.spriteSheet}];l.backgroundImage&&f.push({id:"backGroundImage",url:l.backgroundImage}),Preloader.init(f,function(){buildSpriteSheet(Resources.images.spritesheet,function(){if(UI.init(),"undefined"!=typeof GameObjects&&(GameObjects.init(),l.defaultGameObject=GameObjects[l.defaultGameObject]),Map.init(b),l.backgroundPattern&&isNumeric(l.backgroundPattern)&&(m=ctx.createPattern(sprites[l.backgroundPattern],"repeat")),m||(m="Black"),l.backgroundImage){n=document.createElement("canvas"),n.width=2048,n.height=1024;var a=n.getContext("2d");a.globalAlpha=l.backgroundImageAlpha||1,a.drawImage(Resources.images.backGroundImage,0,0),E()}else E()})})};var E=function(){l.start?l.start():l.level&&p.loadLevel(l.level),b()};return p.start=function(){if(UI.removeAllElements(),l.showOnScreenControls){o=new UI.GameController(l.onScreenControlsImage),UI.addElement(o);var a=new UI.Button({id:"action",url:l.actionButtonImage,bottom:canvas.height-40,right:canvas.width-20,width:74,height:74,states:[[0,0,74,74],[79,0,74,74]],onDown:function(){Input.isAction(!0),this.setSate(1)},onUp:function(){Input.isAction(!1),this.setSate(0)},onResize:function(a){a.right=canvas.width-20,a.left=a.right-a.width,a.bottom=canvas.height-40,a.top=a.bottom-a.height}});UI.addElement(a)}var b=new UI.Button({id:"close",url:l.closeButtonImage,top:10,right:canvas.width-10,onClick:function(){p.exit()},onResize:function(a){a.right=canvas.width-10,a.left=a.right-a.width}});UI.addElement(b),p.resetScore(),p.isWon(!1),p.isLost(!1),p.setHint("Good luck!"),p.setGameSection(d)},p.exit=function(){Intro.init()},p.loadLevel=function(a){"string"==typeof a&&Map.loadFromUrl(a,function(){p.start()})},p.getTileSize=function(){return i},p.getTargetTicksPerSecond=function(){return t},p.getViewPort=function(){return{width:l.viewPortWidth,height:l.viewPortHeight}},p.getCanvasSize=function(){return{width:l.canvasWidth,height:l.canvasHeight}},p.getSettings=function(){return l},p.getRandomDirection=function(){return DIRECTION.LEFT+Math.floor(4*random())},p.getRandomHorizontalDirection=function(){return random()<=.5?DIRECTION.LEFT:DIRECTION.RIGHT},p.getDirectionTurnedLeft=function(a){var b=a-1;return DIRECTION.LEFT>b&&(b=DIRECTION.DOWN),b},p.getDirectionTurnedRight=function(a){var b=a+1;return b>DIRECTION.DOWN&&(b=DIRECTION.LEFT),b},p.getDirectionName=function(a){switch(a){case DIRECTION.LEFT:return"Left";case DIRECTION.RIGHT:return"Right";case DIRECTION.UP:return"Up";case DIRECTION.DOWN:return"Down";default:return"none"}},p.setTargetScore=function(a){z=a},p.addScore=function(a){x+=a},p.resetScore=function(){x=0,"undefined"!=typeof GameObjects&&GameObjects.resetState()},p.setHint=function(a){y=a},p.hasTargetScore=function(){return x>=z},p.isWon=function(a){return a&&(A=a),A&&(y="You made it!"),A},p.isLost=function(a){return a&&(B=a),B&&(y="Forget it!"),B},p.setGameSection=function(a){D=a},p}(),Input=function(){function a(a){var b=a.keyCode;b==i.down&&(c=!0),b==i.left&&(e=!0),b==i.right&&(f=!0),b==i.up&&(d=!0),b==i.space&&(g=!0),b==i.ctrl&&(g=!0)}function b(a){var b=a.keyCode;b==i.down&&(c=!1),b==i.left&&(e=!1),b==i.right&&(f=!1),b==i.up&&(d=!1),b==i.space&&(g=!1),b==i.ctrl&&(g=!1)}var c,d,e,f,g,h={},i={left:37,up:38,right:39,down:40,space:32,ctrl:17};return document.addEventListener("keydown",a,!1),document.addEventListener("keyup",b,!1),h.isDown=function(a){return"undefined"!=typeof a&&(c=a),c},h.isUp=function(a){return"undefined"!=typeof a&&(d=a),d},h.isLeft=function(a){return"undefined"!=typeof a&&(e=a),e},h.isRight=function(a){return"undefined"!=typeof a&&(f=a),f},h.isAction=function(a){return"undefined"!=typeof a&&(g=a),g},h}(),Map=function(){var a={},b=[];return a.init=function(){},a.loadFromUrl=function(c,d){b=[],loadUrl(c,function(b){if(b.layers)for(var c=1;b.layers.length>=c;c++){var e=b.layers[c-1];e.id="layer"+c,e.zIndex=c,a.addLayer(e)}else b.id="layer1",b.zIndex=1,a.addLayer(b);d&&d()})},a.addLayer=function(a){var c=void 0;a.type&&(c=a.type),!c&&a.map&&(c=MAPLAYERTYPE.GRID),c||(c=MAPLAYERTYPE.FREE),a.type=c,a.speed=a.speed||1;var d=new MapLayer(a);return b.push(d),d},a.getLayer=function(a){for(var c=0;b.length>c;c++)if(b[c].id==a)return b[c];return void 0},a.onResize=function(){},a.process=function(){for(var a=0;b.length>a;a++)b[a].process()},a.render=function(){for(var a=0;b.length>a;a++)b[a].render()},a.cleanUp=function(){for(var a=0;b.length>a;a++)b[a].cleanUp()},a.sortLayers=function(){sortByKey(b,"zIndex")},a}(),MapLayer=function(a){function b(a){var b=0,c=1;a.mapStructure&&a.mapStructure.charCount&&(c=a.mapStructure.charCount),Game.setTargetScore(a.minimumScore||0),e.levelHeight=a.map.length,e.activeObjectCount=0,e.inactiveObjectCount=0;for(var d=0;e.levelHeight>d;d++){var f=a.map[d];e.levelWidth=f.length/c;for(var g=0;e.levelWidth>g;g++){b=d*e.levelWidth+g;for(var h="",i=0;c>i;i++)h+=f[g*c+i];var j=GameObjects[h]||Game.getSettings().defaultGameObject,k=new MapPosition(j,b,e);j.id==GameObjects.PLAYER.id&&(e.playerObject=k,e.scrollTilesX=Math.max(g-10,0),e.scrollTilesY=Math.max(d-10,0)),e.objects.push(k),j.inActive?e.inactiveObjectCount++:e.activeObjectCount++}}}if(a.parentLayer){var c=a.parentLayer;a.width=c.width,a.height=c.height,a.speed=c.speed,c.addSubLayer(this)}for(var d in a)this[d]=a[d];this.objects=[],this.sublayers=[],this.activeObjectCount=0,this.inactiveObjectCount=0,this.playerObject=void 0;var e=this;if(this.levelWidth=a.width,this.levelHeight=a.height,this.scrollOffsetX=0,this.scrollOffsetY=0,this.scrollTilesX=0,this.scrollTilesY=a.startY||0,this.scrollDirection=0,this.viewPortWidth=10,this.viewPortHeight=10,this.borderScrollOffset=5,this.step=0,this.speed){var f=1/this.speed;this.targetTicksPerSecond=Game.getTargetTicksPerSecond()*f}else this.targetTicksPerSecond=Game.getTargetTicksPerSecond();this.tileSize||(this.tileSize=Game.getTileSize()),this.scrollStep=this.tileSize/this.targetTicksPerSecond,a.map&&b(a)};MapLayer.prototype.isActive=function(){return this.activeObjectCount>0},MapLayer.prototype.process=function(){var a=!0;if(this.type==MAPLAYERTYPE.SPOT&&(a=!1),this.isActive()||(a=!1),this.type==MAPLAYERTYPE.GRID&&0!=this.step&&(a=!1),a){this.playerObject&&this.playerObject.process();for(var b=0,c=this.objects.length;c>b;b++){var d=this.objects[b];d&&d.process()}}this.initScroll()},MapLayer.prototype.addObject=function(a,b){b=b||MAPOBJECTTYPE.GRID,a.objectType=b,a.mapLayer=this,this.objects.push(a),a.inActive||this.activeObjectCount++},MapLayer.prototype.removeObject=function(a){var b=this.objects.indexOf(a);b>=0&&this.objects.splice(b,1)},MapLayer.prototype.clear=function(){this.objects=[]},MapLayer.prototype.getScrollOffset=function(){return this.parentLayer?this.parentLayer.getScrollOffset():{x:this.scrollOffsetX,y:this.scrollOffsetY,tileX:this.scrollTilesX,tileY:this.scrollTilesY}},MapLayer.prototype.setScrollOffset=function(a){this.scrollTilesX=a.tileX,this.scrollTilesY=a.tileY},MapLayer.prototype.render=function(){this.step++,this.step>=this.targetTicksPerSecond&&(this.step=0);for(var a=this.getScrollOffset(),b=0,c=this.objects.length;c>b;b++){var d=this.objects[b];d.isVisible(a)&&d.render(this.step,a,0)}},MapLayer.prototype.cleanUp=function(){this.type==MAPLAYERTYPE.GRID&&this.step>=this.targetTicksPerSecond-1&&(this.autoScrollDirection==DIRECTION.DOWN&&0>=this.scrollTilesY&&this.onEnd&&this.onEnd(this),this.fullStep())},MapLayer.prototype.fullStep=function(){if(this.isActive())for(var a=0,b=this.objects.length;b>a;a++){var c=this.objects[a];c.fullStep(this.step)}switch(this.scrollDirection){case DIRECTION.LEFT:this.scrollTilesX++;break;case DIRECTION.RIGHT:this.scrollTilesX--;break;case DIRECTION.DOWN:this.scrollTilesY--;break;case DIRECTION.UP:this.scrollTilesY++}this.scrollDirection=DIRECTION.NONE,this.scrollOffsetX=0,this.scrollOffsetY=0},MapLayer.prototype.setPlayerObject=function(a){this.playerObject=a},MapLayer.prototype.getPlayerObject=function(){return this.playerObject},MapLayer.prototype.initScroll=function(){if(!this.parentLayer){var a=this,b=function(b){var c=a.scrollStep;switch(a.scrollDirection=b,a.scrollOffsetX=0,a.scrollOffsetY=0,b){case DIRECTION.LEFT:a.scrollOffsetX=-c;break;case DIRECTION.RIGHT:a.scrollOffsetX=c;break;case DIRECTION.DOWN:a.scrollOffsetY=c;break;case DIRECTION.UP:a.scrollOffsetY=-c}};this.playerObject&&(this.borderScrollOffset>this.scrollTilesX+this.viewPortWidth-this.playerObject.left&&this.playerObject.moveDirection==DIRECTION.RIGHT&&b(DIRECTION.LEFT),this.borderScrollOffset>this.playerObject.left-this.scrollTilesX&&this.playerObject.moveDirection==DIRECTION.LEFT&&b(DIRECTION.RIGHT),this.borderScrollOffset>this.scrollTilesY+this.viewPortHeight-this.playerObject.top&&this.playerObject.moveDirection==DIRECTION.DOWN&&b(DIRECTION.UP),this.borderScrollOffset>this.playerObject.top-this.scrollTilesY&&this.playerObject.moveDirection==DIRECTION.UP&&b(DIRECTION.DOWN)),this.autoScrollDirection&&b(this.autoScrollDirection)}},MapLayer.prototype.setAutoScroll=function(a){this.autoScrollDirection=a},MapLayer.prototype.addSubLayer=function(a){this.sublayers.push(a)},MapLayer.prototype.removeSubLayer=function(a){for(var b=0,c=this.sublayers.length;c>b;b++)this.sublayers[b].id==a.id&&this.sublayers.splice(b,1)};var MapObject=function(a){for(var b in a)this[b]=a[b];this.id=this.gameObject.id,this.staticFrame=this.gameObject.getStaticFrame();var c=sprites[this.staticFrame];this.height=c.height,this.width=c.width};MapObject.prototype.isVisible=function(){return!0},MapObject.prototype.render=function(){var a=this.left,b=this.top;if(this.id>0){var c;this.animation?(this.animationStartFrame++,this.animationStartFrame>=this.animation.length&&(this.animationStartFrame=0),c=this.gameObject.getAnimationFrame(this.animation,this.animationStartFrame)):c=sprites[this.staticFrame],ctx.drawImage(c,a,b)}},MapObject.prototype.process=function(){if(!this.processed){var a=this,b=a.gameObject;b.inActive||(b.isPlayer(),b.eachStep&&b.eachStep(this))}},MapObject.prototype.destroy=function(){this.mapLayer.removeObject(this)},MapObject.prototype.detectCollistion=function(){for(var a=0;this.mapLayer.objects.length>a;a++){var b=this.mapLayer.objects[a];b&&b.gameObject.isEnemy&&b.left+b.width>this.left&&this.left+this.width>b.left&&b.top+b.height>this.top&&this.height+this.top>b.top&&(this.mapLayer.addObject(new MapObject({left:b.left-8,top:b.top-8,gameObject:GameObjects.EXPLOSION})),b.destroy())}},MapObject.prototype.animate=function(a){"string"==typeof a||"number"==typeof a?(this.animation=this.gameObject[a],this.animation||(this.animation=this.gameObject["animation"+a]),this.animation||(this.animation=this.gameObject.animationFrames[a]),this.animation||(this.animation=this.gameObject.animationFrames["animation"+a])):this.animation=a,this.animationStartFrame=0},MapObject.prototype.animateIfPossible=function(a){this.isAnimating()||this.animate(a)},MapObject.prototype.isAnimating=function(){return this.animation};var Resources={images:{}},Preloader=function(){var a,b,c,d,e,f,g={};return g.init=function(h,i){if(e=200,f=10,d=(canvas.width-e)/2,c=(canvas.height-f)/2,b=h.length,0==b)i();else{var j=function(){g.render(),a==b&&i&&i()};g.render(),g.load(h,j)}},g.load=function(c,d){a=0;for(var e,f=0;b>f;f++){var g=c[f];e=g.url?g.url:g;var h=new Image;h.onload=function(){a++,this.id&&(Resources.images[this.id]=this),d&&d()},h.onerror=function(){},h.id=g.id,h.src=e}},g.render=function(){UI.clear(),ctx.strokeStyle="white",ctx.fillStyle="white",ctx.rect(d,c,e,f),ctx.stroke();var g=Math.floor(a*e/b);ctx.fillRect(d,c,g,f)},g}(),Sprite=function(a,b,c,d,e,f){if("undefined"==typeof e){var g=c,h=Math.floor(a.width/g);c=b%h*g,d=Math.floor(b/h)*g,e=g,f=g}var i=document.createElement("canvas");i.width=e,i.height=f;var j=i.getContext("2d");return j.drawImage(a,c,d,e,f,0,0,e,f),i},buildSpriteSheet=function(a,b){var c=Game.getSettings().spriteMap;if(c)for(var d=0;spriteMap.length>d;d++){var e=spriteMap[d],f=new Sprite(a,e.name,e.l,e.r,e.w,e.h);sprites.push(f),spriteNames[e.name]=sprites.length-1}else for(var g=Game.getSettings().tileSize,h=Math.floor(a.width/g)*Math.floor(a.height/g),d=0;h>d;d++){var f=new Sprite(a,d,Game.getSettings().tileSize);sprites.push(f)}b&&b()},UI=function(){function a(a){function b(a,b,c){h.isTouchDown=!0;var d=b/f,e=c/g,i={id:a,x:d,y:e,startX:d,startY:e,UIobject:UI.getEventElement(d,e)};h.touches.push(i),i.UIobject&&i.UIobject.element&&i.UIobject.element.onDown&&i.UIobject.element.onDown(i)}if(a.preventDefault(),a.touches&&a.touches.length>0)for(var c=a.changedTouches,d=0;c.length>d;d++){var e=c[d];b(e.identifier,e.pageX,e.pageY)}else{var j=i("notouch");j>=0&&h.touches.splice(j,1),b("notouch",a.pageX,a.pageY)}}function b(a){function b(a,b,c){if(a>=0){var d=h.touches[a];d.x=b/f,d.y=c/f,h.touches.splice(a,1,d),h.isTouchDown&&d.UIobject&&d.UIobject.element&&d.UIobject.element.onDrag&&d.UIobject.element.onDrag(d)}}if(a.preventDefault(),a.touches&&a.touches.length>0)for(var c=a.changedTouches,d=0;c.length>d;d++){var e=c[d];b(i(e.identifier),e.pageX,e.pageY)}else b(i("notouch"),a.pageX,a.pageY),h.currentMouseX=a.pageX,h.currentMouseY=a.pageY}var c,d={},e=[],f=1,g=1,h={};h.touches=[],d.init=function(){canvas.addEventListener("mousedown",a,!1),canvas.addEventListener("mousemove",b,!1),canvas.addEventListener("mouseup",j,!1),canvas.addEventListener("touchstart",a,!1),canvas.addEventListener("touchmove",b,!1),canvas.addEventListener("touchend",j,!1),canvas.addEventListener("mousewheel",k,!1),canvas.addEventListener("DOMMouseScroll",k,!1),window.navigator.msPointerEnabled&&(canvas.addEventListener("MSPointerDown",a,!1),canvas.addEventListener("MSPointerMove",b,!1),canvas.addEventListener("MSPointerEnd",j,!1))},d.registerEventElement=function(a,b,d,e,f){c.push({element:a,top:d,right:e,bottom:f,left:b})},d.getEventElement=function(a,b){for(var d,e=0,f=c.length;f>e;e++){var g=c[e];a>=g.left&&g.right>=a&&b>=g.top&&g.bottom>=b&&(d=g)}return d},d.clear=function(a){a=a||"Black",ctx.fillStyle=a,ctx.fillRect(0,0,canvas.width,canvas.height),c=[]},d.removeAllElements=function(){e=[],c=[]},d.addElement=function(a){e.push(a)},d.renderElements=function(){for(var a=0,b=e.length;b>a;a++){var c=e[a];c.render()}},d.setScale=function(a,b){f=a,g=b},d.onResize=function(){for(var a=0,b=e.length;b>a;a++){var c=e[a];c.onResize&&c.onResize(c)}};var i=function(a){for(var b=0;h.touches.length>b;b++)if(h.touches[b].id===a)return b;return-1},j=function(a){function b(a){if(a>=0){var b=h.touches[a];if(b.UIobject&&b.UIobject.element){var c=b.UIobject.element;c.onClick&&c.onClick(b),c.onUp&&c.onUp(b)}h.touches.splice(a,1)}}function c(){Input.isDown(!1),Input.isUp(!1),Input.isLeft(!1),Input.isRight(!1)}if(a&&a.touches){for(var d=a.changedTouches,e=0;d.length>e;e++){var f=d[e];b(i(f.identifier))}0==a.touches.length&&c()}else b(i("notouch")),c()},k=function(a){if(h.currentMouseX){var b=a.wheelDelta||-a.detail,c=h.currentMouseX/f,d=h.currentMouseY/g,e=UI.getEventElement(c,d);e&&e.element&&e.element.onMouseWheel&&e.element.onMouseWheel(b)}};return d}(),requestAnimFrame=function(){return window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(a){window.setTimeout(function(){a(+new Date)},1e3/60)}}(),cancelAnimFrame=function(){return window.cancelAnimationFrame||window.webkitCancelAnimationFrame||window.mozCancelAnimationFrame||window.oCancelAnimationFrame||function(a){window.clearTimeout(a)}}();window.performance=window.performance||{},performance.now=function(){return performance.now||performance.mozNow||performance.msNow||performance.oNow||performance.webkitNow||function(){return(new Date).getTime()}}();var randomSeed=1,canvas,ctx,map=[],sprites=[],spriteNames={},DIRECTION={LEFT:37,UP:38,RIGHT:39,DOWN:40,LEFTUP:3738,RIGHTUP:3938,LEFTDOWN:3740,RIGHTDOWN:3940,NONE:0},DIRECTION_OPPOSITE={37:DIRECTION.RIGHT,38:DIRECTION.DOWN,39:DIRECTION.LEFT,40:DIRECTION.UP},ANIMATION={PUSH_RIGHT:"PushRight",PUSH_LEFT:"PushLeft",PUSH_UP:"PushUp",PUSH_DOWN:"PushDown"},SCALING={NONE:0,FIT_WIDTH:1,FIT_HEIGHT:2,CONTAIN:3,STRETCH:4},MAPLAYERTYPE={GRID:1,SPOT:2,FREE:3},MAPOBJECTTYPE={GRID:1,FIXED:2,FREE:3},GameObjectIndex=[],GameObject=function(a){var b=!1;for(var c in a)this[c]=a[c],"function"==typeof a[c]&&(b=!0);if(this.setDefault("canMove",!1),this.setDefault("canBeCollected",!1),this.setDefault("canFall",!1),this.setDefault("isStableSurface",!0),this.canFall&&this.setDefault("onFallen",function(a,b){!b.isMoving()&&b.gameObject.canBeCrushedBy&&b.gameObject.canBeCrushedBy(a)&&(a.move(DIRECTION.DOWN),b.gameObject.onCrushed&&b.gameObject.onCrushed(a,b))}),this.spriteIndex=this.id,a.spriteIndex&&(this.spriteIndex=a.spriteIndex),this.spriteIndexes=a.spriteIndexes,!isNumeric(this.spriteIndex)){var d=spriteNames[this.spriteIndex];d>=0&&(this.spriteIndex=d)}if(this.animationFrames={},a.animationRight&&(this.animationFrames[DIRECTION.RIGHT]=a.animationRight),a.animationLeft&&(this.animationFrames[DIRECTION.LEFT]=a.animationLeft),a.animationUp&&(this.animationFrames[DIRECTION.UP]=a.animationUp),a.animationDown&&(this.animationFrames[DIRECTION.DOWN]=a.animationDown),this.isGameObject=!0,this.inActive=!(this.canMove||this.canFall||b),GameObjects[this.id]=this,GameObjects[this.code]=this,GameObjectIndex.push(this),this.alias)if("string"==typeof this.alias)GameObjects[this.alias]=this;else for(var e=0;this.alias.length>e;e++)GameObjects[this.alias[e]]=this};GameObject.prototype.getAnimationFrame=function(a,b){var c=this.spriteIndex;if(a){var d=Math.min(b,a.length-1);c=a[d]}return sprites[c]},GameObject.prototype.getStaticFrame=function(){var a=this.spriteIndex;return this.spriteIndexes&&this.spriteIndexes.length>0&&(a=this.spriteIndexes[Math.floor(Math.random()*this.spriteIndexes.length)]),a},GameObject.prototype.isEmpty=function(){return 0==this.id},GameObject.prototype.isPlayer=function(){return this.id==GameObjects.PLAYER.id},GameObject.prototype.setDefault=function(a,b){"undefined"==typeof this[a]&&(this[a]=b)};var MapPosition=function(a,b,c){this.gameObject=a,this.id=a.id,this.index=b,this.staticFrame=a.getStaticFrame(),this.mapLayer=c,this.left=b%c.levelWidth,this.top=Math.floor(b/c.levelWidth),this.tileSize=Game.getTileSize(),this.tickOffset=this.tileSize/Game.getTargetTicksPerSecond()};MapPosition.prototype.isVisible=function(a){return this.left>=a.tileX-1&&this.left<a.tileX+Game.getViewPort().width+1&&this.top>=a.tileY-1&&this.top<a.tileY+Game.getViewPort().height+1},MapPosition.prototype.render=function(a,b,c){var d=(this.left-b.tileX)*this.tileSize,e=(this.top-b.tileY)*this.tileSize;isDefined(c)||(c=1),d+=b.x*a,e+=b.y*a;var f=d,g=e;if(this.moveDirection==DIRECTION.DOWN&&(e+=a*this.tickOffset),this.moveDirection==DIRECTION.UP&&(e-=a*this.tickOffset),this.moveDirection==DIRECTION.LEFT&&(d-=a*this.tickOffset),this.moveDirection==DIRECTION.RIGHT&&(d+=a*this.tickOffset),this.bottomlayer&&"bottom"==this.mapLayer.id)h=sprites[this.bottomlayer],ctx.drawImage(h,f,g);else{if(this.id>0){var h;h=this.animation?this.gameObject.getAnimationFrame(this.animation,a+this.animationStartFrame):sprites[this.staticFrame],ctx.drawImage(h,d,e)}this.toplayer&&(h=sprites[this.toplayer],ctx.drawImage(h,f,g))}},MapPosition.prototype.process=function(){if(!this.processed){var a,b=this,c=b.gameObject;if(!c.inActive){if(c.isPlayer()){var d,e,f,g;if(Input.isAction()?(this.actionDownCount=(this.actionDownCount||0)+1,this.actionDownCount>5&&this.gameObject.onLongPress&&this.gameObject.onLongPress(this),Input.isDown()&&(d=this.zapIfPossible(DIRECTION.DOWN)),Input.isUp()&&(e=this.zapIfPossible(DIRECTION.UP)),Input.isLeft()&&(f=this.zapIfPossible(DIRECTION.LEFT)),Input.isRight()&&(g=this.zapIfPossible(DIRECTION.RIGHT))):(this.actionDownCount=0,Input.isDown()&&(d=this.moveIfPossible(DIRECTION.DOWN)),Input.isUp()&&(e=this.moveIfPossible(DIRECTION.UP)),Input.isLeft()&&(f=this.moveIfPossible(DIRECTION.LEFT)),Input.isRight()&&(g=this.moveIfPossible(DIRECTION.RIGHT))),a=d||e||f||g){var h=void 0;d&&(h=DIRECTION.DOWN),e&&(h=DIRECTION.UP),f&&(h=DIRECTION.LEFT),g&&(h=DIRECTION.RIGHT),a.gameObject.onCollected&&a.gameObject.onCollected(this,a,h),Input.isAction()&&a.transformInto(Game.getSettings().defaultGameObject)}this.isMoving()||(Input.isRight()&&(a=this.getObject(DIRECTION.RIGHT),a.gameObject.canBePushed&&a.gameObject.canBePushed.horizontal&&(this.animate(ANIMATION.PUSH_RIGHT),!a.canMove(DIRECTION.RIGHT)||a.gameObject.canFall&&a.canMove(DIRECTION.DOWN)||Maybe(function(){a.move(DIRECTION.RIGHT),b.move(DIRECTION.RIGHT)},1-a.gameObject.canBePushed.friction))),Input.isLeft()&&(a=this.getObject(DIRECTION.LEFT),a.gameObject.canBePushed&&a.gameObject.canBePushed.horizontal&&(this.animate(ANIMATION.PUSH_LEFT),!a.canMove(DIRECTION.LEFT)||a.gameObject.canFall&&a.canMove(DIRECTION.DOWN)||Maybe(function(){a.move(DIRECTION.LEFT),b.move(DIRECTION.LEFT)},1-a.gameObject.canBePushed.friction))),Input.isUp()&&(a=this.getObject(DIRECTION.UP),a.gameObject.canBePushed&&a.gameObject.canBePushed.vertical&&(this.animate(ANIMATION.PUSH_UP),a.canMove(DIRECTION.UP)&&Maybe(function(){a.move(DIRECTION.UP),b.move(DIRECTION.UP)},1-a.gameObject.canBePushed.friction))),Input.isDown()&&(a=this.getObject(DIRECTION.DOWN),a.gameObject.canBePushed&&a.gameObject.canBePushed.vertical&&(this.animate(ANIMATION.PUSH_DOWN),a.canMove(DIRECTION.DOWN)&&Maybe(function(){a.move(DIRECTION.DOWN),b.move(DIRECTION.DOWN)},1-a.gameObject.canBePushed.friction))))}else if(c.canFall&&this.moveIfPossible(DIRECTION.DOWN),!this.isMoving()&&!this.wasMoving()&&c.canFall&&!this.getObject(DIRECTION.DOWN).gameObject.isStableSurface){var i=this.canMove(DIRECTION.LEFTDOWN),j=this.canMove(DIRECTION.RIGHTDOWN);i&&j&&this.move(Game.getRandomHorizontalDirection()),this.isMoving()||(i&&this.move(DIRECTION.LEFT),j&&this.move(DIRECTION.RIGHT))}this.wasMoving()&&!this.isMoving()&&this.wasMovingToDirection==DIRECTION.DOWN&&(a=this.getObject(DIRECTION.DOWN),c.onFallen&&c.onFallen(this,a),a.gameObject.onHit&&a.gameObject.onHit(this,DIRECTION.DOWN,a)),c.eachStep&&c.eachStep(this),this.isMoving()&&!c.isPlayer()&&(a=this.getObject(this.moveDirection),a.gameObject.onCollected&&!a.isMoving()&&a.gameObject.onCollected(c,a,this.moveDirection)),this.processed=!0}}},MapPosition.prototype.fullStep=function(a){if(this.next){for(var b in this.next)this[b]=this.next[b];this.gameObject=GameObjects[this.id],this.staticFrame=this.gameObject.getStaticFrame(),this.wasMovingToDirection=this.movingInToDirection,this.id==GameObjects.PLAYER.id&&this.mapLayer.setPlayerObject(this),this.animation=!1}else this.wasMovingToDirection=void 0;this.animation&&(this.animation.length>this.animationStartFrame+a+1?this.animationStartFrame=this.animationStartFrame+a+1:this.animation=!1),this.reset(),this.action&&(this.action(this),this.action=void 0)},MapPosition.prototype.reset=function(){this.moveDirection=void 0,this.next=void 0,this.movingInToDirection=void 0,this.processed=!1},MapPosition.prototype.setNext=function(a,b){this.next=this.next||{},this.next[a]=b},MapPosition.prototype.getObject=function(a){var b=this.mapLayer.levelWidth,c=this.mapLayer.objects;switch(a){case DIRECTION.DOWN:return c[this.index+b];case DIRECTION.UP:return c[this.index-b];case DIRECTION.LEFT:return c[this.index-1];case DIRECTION.RIGHT:return c[this.index+1];case DIRECTION.LEFTDOWN:return c[this.index-1+b];case DIRECTION.RIGHTDOWN:return c[this.index+1+b];case DIRECTION.LEFTUP:return c[this.index-1-b];case DIRECTION.RIGHTUP:return c[this.index+1-b];case DIRECTION.NONE:return c[this.index]}},MapPosition.prototype.canMove=function(a){if(this.isMoving())return!1;var b;if(a>100){if(a==DIRECTION.LEFTDOWN){var c=this.getObject(DIRECTION.LEFT),d=this.getObject(DIRECTION.LEFTDOWN);if(c.next||d.next)return!1;if(this.gameObject.canMoveTo(c,DIRECTION.LEFT)&&this.gameObject.canMoveTo(d,DIRECTION.DOWN))return!0}if(a==DIRECTION.RIGHTDOWN){var e=this.getObject(DIRECTION.RIGHT),d=this.getObject(DIRECTION.RIGHTDOWN);if(e.next||d.next)return!1;if(this.gameObject.canMoveTo(e,DIRECTION.RIGHT)&&this.gameObject.canMoveTo(d,DIRECTION.DOWN))return!0}}else if(b=this.getObject(a)){if(b.next&&b.next.id)return!1;if(this.gameObject.canMoveTo(b,a))return!0}return!1},MapPosition.prototype.canMoveLeft=function(){return this.canMove(DIRECTION.LEFT)},MapPosition.prototype.canMoveRight=function(){return this.canMove(DIRECTION.RIGHT)},MapPosition.prototype.canMoveUp=function(){return this.canMove(DIRECTION.UP)},MapPosition.prototype.canMoveDown=function(){return this.canMove(DIRECTION.DOWN)},MapPosition.prototype.isMoving=function(){return!!this.moveDirection},MapPosition.prototype.wasMoving=function(){return!!this.wasMovingToDirection},MapPosition.prototype.sameDirection=function(){return this.wasMovingToDirection},MapPosition.prototype.move=function(a){this.moveDirection=a;var b=this.nextObjectId||0;this.setNext("id",b),this.nextObjectId=void 0,this.animate(a),this.onMove&&(this.onMove(this),this.onMove=void 0);var c=this.getObject(a);return c.setNext("id",this.id),c.setNext("_objectProperties",this._objectProperties),c.movingInToDirection=a,c},MapPosition.prototype.moveIfPossible=function(a){return this.canMove(a)?this.move(a):!1},MapPosition.prototype.moveLeftIfPossible=function(){this.moveIfPossible(DIRECTION.LEFT)},MapPosition.prototype.moveRightIfPossible=function(){this.moveIfPossible(DIRECTION.RIGHT)},MapPosition.prototype.moveUpIfPossible=function(){this.moveIfPossible(DIRECTION.UP)},MapPosition.prototype.moveDownIfPossible=function(){this.moveIfPossible(DIRECTION.DOWN)},MapPosition.prototype.animate=function(a){"string"==typeof a||"number"==typeof a?(this.animation=this.gameObject[a],this.animation||(this.animation=this.gameObject["animation"+a]),this.animation||(this.animation=this.gameObject.animationFrames[a]),this.animation||(this.animation=this.gameObject.animationFrames["animation"+a])):this.animation=a,this.animationStartFrame=0},MapPosition.prototype.zapIfPossible=function(a){var b=!1;return this.canMove(a)&&(b=this.getObject(a)),b},MapPosition.prototype.animateIfPossible=function(a){this.isAnimating()||this.animate(a)},MapPosition.prototype.isAnimating=function(){return this.animation},MapPosition.prototype.isNextTo=function(a){var b=this.getObject(DIRECTION.LEFT).gameObject.id,c=this.getObject(DIRECTION.RIGHT).gameObject.id,d=this.getObject(DIRECTION.DOWN).gameObject.id,e=this.getObject(DIRECTION.UP).gameObject.id,f=a.id;return b==f||e==f||c==f||d==f},MapPosition.prototype.refresh=function(){this.setNext("id",this.id)},MapPosition.prototype.transformInto=function(a,b,c){this.setNext("id",a.id),b&&this.animate(b),c&&this.setNext("action",c)},MapPosition.prototype.addLayer=function(a,b){if("bottom"==b){this.bottomlayer=a;var c=Map.getLayer("bottom");c||(c=Map.addLayer({id:"bottom",zIndex:0,type:MAPLAYERTYPE.SPOT,parentLayer:this.mapLayer}),Map.sortLayers());var d=new MapPosition(this.gameObject,this.index,c);c.addObject(d,MAPOBJECTTYPE.GRID)}else this.toplayer=a},MapPosition.prototype.removeLayer=function(a){if("bottom"==a){this.bottomlayer=void 0;var b=Map.getLayer("bottom");b&&b.removeObject(this)}else this.toplayer=void 0},MapPosition.prototype.hasLayer=function(a){return"bottom"==a?void 0!=this.bottomlayer:void 0!=this.toplayer},MapPosition.prototype.objectProperties=function(){return this._objectProperties=this._objectProperties||{}},MapPosition.prototype.getExplodeIntoObjects=function(){var a=Game.getSettings().defaultGameObject;return this.gameObject.explodeIntoObjects&&(a=this.gameObject.explodeIntoObjects()),this.gameObject.explodeIntoObject&&(a=this.gameObject.explodeIntoObject),a},UI.Button=function(a){var b=this;for(var c in a)this[c]=a[c];this.image=new Image,this.image.onload=function(){isDefined(b.width)||(b.width=this.width),isDefined(b.height)||(b.height=this.height),b.states||(b.states=[[0,0,b.width,b.height]]),isDefined(b.initialState)||(b.initialState=0),b.state=b.states[b.initialState],b.imageLoaded=!0,b.setPosition()},this.image.src=this.url},UI.Button.prototype.setSate=function(a){this.state=this.states[a]},UI.Button.prototype.setPosition=function(){isDefined(this.left)||(this.left=this.right-this.width),isDefined(this.right)||(this.right=this.left+this.width),isDefined(this.top)||(this.top=this.bottom-this.height),isDefined(this.bottom)||(this.bottom=this.top+this.height)},UI.Button.prototype.render=function(){this.imageLoaded&&(ctx.drawImage(this.image,this.state[0],this.state[1],this.state[2],this.state[3],this.left,this.top,this.width,this.height),UI.registerEventElement(this,this.left,this.top,this.right,this.bottom))
},UI.GameController=function(a){var b=this;this.sprites=[],this.state=0,this.image=new Image,this.image.onload=function(){b.tileSize=this.height;for(var a=0;5>a;a++){var c=new Sprite(this,a,b.tileSize);b.sprites.push(c)}b.imageLoaded=!0,b.setPosition()},this.image.src=a,this.onDown=function(a){d(a.x,a.y)},this.onDrag=function(a){d(a.x,a.y)},this.onUp=function(){c()};var c=function(){b.state=DIRECTION.NONE,Input.isLeft(!1),Input.isRight(!1),Input.isUp(!1),Input.isDown(!1)},d=function(a,d){c(),a-=b.left,d-=b.top;var e=16,f=b.tileSize/2;f-e>a&&(Input.isLeft(!0),b.state=DIRECTION.LEFT),a>f+e&&(Input.isRight(!0),b.state=DIRECTION.RIGHT),f-e>d&&(Input.isUp(!0),b.state=DIRECTION.UP),d>f+e&&(Input.isDown(!0),b.state=DIRECTION.DOWN)}},UI.GameController.prototype.setPosition=function(){this.top=canvas.height-150,this.left=10,this.right=this.left+this.tileSize,this.bottom=this.top+this.tileSize},UI.GameController.prototype.render=function(){if(this.imageLoaded){var a=Math.max(this.state-DIRECTION.LEFT+1,0);ctx.drawImage(this.sprites[a],this.left,this.top),UI.registerEventElement(this,this.left,this.top,this.right,this.bottom)}},UI.Listbox=function(a){function b(a){return a>d.minScollPosition&&(a=d.minScollPosition),0-d.maxScrollPosition>a&&(a=0-d.maxScrollPosition),a}function c(a,b){return(a?0>a?-1:1:0)==(b?0>b?-1:1:0)}var d=this;this.items=a.items,this.onSelect=a.onSelect,this.onResize=a.onResize,this.scrollOffetY=a.scrollY||0,this.scrollDeltaY=0,this.scrollSpeed=0,this.scrollElastic=0,this.scrollHistory=[],this.scrollThreshold=5,this.itemHeight=a.itemHeight||64,this.top=a.top,this.left=a.left||100,this.width=a.width||400,this.height=a.height||400,this.minScollPosition=0,this.maxScrollPosition=this.items.length*this.itemHeight-this.height,this.preserveState=a.preserveState||function(){};for(var e=function(a){var b=a.y-a.startY;d.scrollDeltaY=parseInt(b)},f=function(a){if(Math.abs(d.scrollDeltaY)<d.scrollThreshold)d.onSelect(a.UIobject.element);else{d.scrollElastic=20;var b=0-h()/10,c=d.scrollOffetY+d.scrollDeltaY,e=(1+d.scrollElastic)*d.scrollElastic/2,f=c+e*b;f>d.minScollPosition&&(b=d.minScollPosition-c/e,f=d.minScollPosition),0-d.maxScrollPosition>f&&(b=(0-c-d.maxScrollPosition)/e,f=0-d.maxScrollPosition),d.preserveState("scrollY",f),d.scrollSpeed=b}d.scrollOffetY+=d.scrollDeltaY,d.scrollDeltaY=0,d.scrollHistory=[]},g=function(a){var c=b(d.scrollOffetY+a/3);d.scrollOffetY=c},h=function(){var a=0,b=d.scrollHistory;if(b.length>0){var e,f=0,g=[];for(e=0;b.length>e;e++){var h=b[e];if(0==h)g.push(h);else{if(0==f&&(f=h),!c(f,h))break;g.push(h)}}if(g.length>0){var i=0;for(e=0;g.length>e;e++)i+=g[e];a=i/g.length}return a}},i=0,j=this.items.length;j>i;i++)this.items[i].onUp=f,this.items[i].onDrag=e,this.items[i].onMouseWheel=g},UI.Listbox.prototype.render=function(){function a(a){b+=d;var h=sprites[a.icon];ctx.fillStyle="Black",ctx.clearRect(c,b+f,e,g),ctx.drawImage(h,c,b),ctx.fillStyle="Grey",ctx.font="normal 10pt Arial",ctx.fillText(a.name,c+40,b+16),UI.registerEventElement(a,c,b,c+e,b+d)}this.scrollOffetY=this.scrollOffetY+this.scrollElastic*this.scrollSpeed;var b=this.top+this.scrollOffetY+this.scrollDeltaY,c=this.left,d=this.itemHeight,e=this.width,f=d-10,g=.5;this.scrollElastic>0&&(this.scrollElastic-=1),this.prevScrollDeltaY=this.prevScrollDeltaY||0;var h=this.prevScrollDeltaY-this.scrollDeltaY;this.scrollHistory.unshift(h),this.scrollHistory.length>10&&this.scrollHistory.pop(),this.prevScrollDeltaY=this.scrollDeltaY;for(var i=0,j=this.items.length;j>i;i++)a(this.items[i])};