function loadUrl(a,b){a=a+"?t="+(new Date).getTime();var c;try{c=new XMLHttpRequest}catch(d){try{c=new ActiveXObject("Msxml2.XMLHTTP")}catch(d){try{c=new ActiveXObject("Microsoft.XMLHTTP")}catch(d){b({})}}}c.onreadystatechange=function(){if(4==c.readyState){var a=JSON.parse(c.responseText);b(a)}},c.open("GET",a,!0),c.send()}function random(){var a=1e4*Math.sin(randomSeed++);return a-Math.floor(a)}function Maybe(a,b){isNaN(b)&&(b=1),random()<=b&&a()}function typeOf(a){var b=typeof a;return"object"===b&&(a?a instanceof Array&&(b="array"):b="null"),b}function isArray(a){return"array"==typeOf(a)}function isBoolean(a){return"boolean"==typeOf(a)}function isFunction(a){return"function"==typeOf(a)}function isDefined(a){return"undefined"!=typeOf(a)}function isNumeric(a){return!isNaN(a)}var canvas,ctx,map=[],sprites=[],DIRECTION={LEFT:37,UP:38,RIGHT:39,DOWN:40,LEFTUP:3738,RIGHTUP:3938,LEFTDOWN:3740,RIGHTDOWN:3940,NONE:0},DIRECTION_OPPOSITE={37:DIRECTION.RIGHT,38:DIRECTION.DOWN,39:DIRECTION.LEFT,40:DIRECTION.UP},ANIMATION={PUSH_RIGHT:"PushRight",PUSH_LEFT:"PushLeft",PUSH_UP:"PushUp",PUSH_DOWN:"PushDown"},SCALING={NONE:0,FIT_WIDTH:1,FIT_HEIGHT:2,CONTAIN:3,STRETCH:4},MAPLAYERTYPE={GRID:0,SPOT:1},GameObjectIndex=[],GameObject=function(a){var b=!1;for(var c in a)this[c]=a[c],"function"==typeof a[c]&&(b=!0);if(this.setDefault("canMove",!1),this.setDefault("canBeCollected",!1),this.setDefault("canFall",!1),this.setDefault("isStableSurface",!0),this.canFall&&this.setDefault("onFallen",function(a,b){!b.isMoving()&&b.gameObject.canBeCrushedBy&&b.gameObject.canBeCrushedBy(a)&&(a.move(DIRECTION.DOWN),b.gameObject.onCrushed&&b.gameObject.onCrushed(a,b))}),this.spriteIndex=this.id,a.spriteIndex&&(this.spriteIndex=a.spriteIndex),this.spriteIndexes=a.spriteIndexes,this.animationFrames={},a.animationRight&&(this.animationFrames[DIRECTION.RIGHT]=a.animationRight),a.animationLeft&&(this.animationFrames[DIRECTION.LEFT]=a.animationLeft),a.animationUp&&(this.animationFrames[DIRECTION.UP]=a.animationUp),a.animationDown&&(this.animationFrames[DIRECTION.DOWN]=a.animationDown),this.isGameObject=!0,this.inActive=!(this.canMove||this.canFall||b),GameObjects[this.id]=this,GameObjects[this.code]=this,GameObjectIndex.push(this),this.alias)if("string"==typeof this.alias)GameObjects[this.alias]=this;else for(var d=0;d<this.alias.length;d++)GameObjects[this.alias[d]]=this};GameObject.prototype.getAnimationFrame=function(a,b){var c=this.spriteIndex;if(a){var d=Math.min(b,a.length-1);c=a[d]}return sprites[c]},GameObject.prototype.getStaticFrame=function(){var a=this.spriteIndex;return this.spriteIndexes&&this.spriteIndexes.length>0&&(a=this.spriteIndexes[Math.floor(Math.random()*this.spriteIndexes.length)]),a},GameObject.prototype.isEmpty=function(){return 0==this.id},GameObject.prototype.isPlayer=function(){return this.id==GameObjects.PLAYER.id},GameObject.prototype.setDefault=function(a,b){"undefined"==typeof this[a]&&(this[a]=b)},GameObject.prototype.canMoveTo=function(a,b){var c=a.gameObject;if(c.isEmpty())return!0;if(this.isPlayer()&&c.canBeCollected){if(isBoolean(c.canBeCollected))return!0;if(isFunction(c.canBeCollected)&&c.canBeCollected(a))return!0}if(c.isPlayer()){if(console.error("isplayer"),a.moveDirection){var d=DIRECTION_OPPOSITE[a.moveDirection];if(b!=d)return!0}if(c.canBeCollectedBy(this,a))return!0}return!1};var MapLayers=[],MapLayer=function(a){for(var b in a)this[b]=a[b];this.objects=[]};MapLayer.prototype.add=function(a){this.objects.push(a)},MapLayer.prototype.remove=function(a){for(var b=0,c=this.objects.length;c>b;b++){var d=this.objects[b];d==a&&this.objects.splice(b,1)}},MapLayer.prototype.clear=function(){this.objects=[]},MapLayer.prototype.render=function(a,b){for(var c=0,d=this.objects.length;d>c;c++){var e=this.objects[c];e.isVisible(b)&&e.render(a,b,0)}};var MapPosition=function(a,b){this.gameObject=a,this.id=a.id,this.index=b,this.staticFrame=a.getStaticFrame(),this.left=b%Game.getLevel().width,this.top=Math.floor(b/Game.getLevel().width),this.tileSize=Game.getTileSize(),this.tickOffset=this.tileSize/Game.getTargetTicksPerSecond()};MapPosition.prototype.isVisible=function(a){return this.left>=a.tileX-1&&this.left<a.tileX+Game.getViewPort().width+1&&this.top>=a.tileY-1&&this.top<a.tileY+Game.getViewPort().height+1},MapPosition.prototype.render=function(a,b,c){var d=(this.left-b.tileX)*this.tileSize,e=(this.top-b.tileY)*this.tileSize;isDefined(c)||(c=1),d+=b.x*a,e+=b.y*a;var f=d,g=e;if(this.moveDirection==DIRECTION.DOWN&&(e+=a*this.tickOffset),this.moveDirection==DIRECTION.UP&&(e-=a*this.tickOffset),this.moveDirection==DIRECTION.LEFT&&(d-=a*this.tickOffset),this.moveDirection==DIRECTION.RIGHT&&(d+=a*this.tickOffset),0==c&&this.bottomlayer)h=sprites[this.bottomlayer],ctx.drawImage(h,f,g);else{if(this.id>0){var h;h=this.animation?this.gameObject.getAnimationFrame(this.animation,a+this.animationStartFrame):sprites[this.staticFrame],ctx.drawImage(h,d,e)}this.toplayer&&(h=sprites[this.toplayer],ctx.drawImage(h,f,g))}},MapPosition.prototype.process=function(){if(!this.processed){var a,b=this,c=b.gameObject;if(!c.inActive){if(this.id==GameObjects.PLAYER.id){var d,e,f,g,a;if(Input.isAction()?(this.actionDownCount=(this.actionDownCount||0)+1,this.actionDownCount>5&&this.gameObject.onLongPress&&this.gameObject.onLongPress(this),Input.isDown()&&(d=this.zapIfPossible(DIRECTION.DOWN)),Input.isUp()&&(e=this.zapIfPossible(DIRECTION.UP)),Input.isLeft()&&(f=this.zapIfPossible(DIRECTION.LEFT)),Input.isRight()&&(g=this.zapIfPossible(DIRECTION.RIGHT))):(this.actionDownCount=0,Input.isDown()&&(d=this.moveIfPossible(DIRECTION.DOWN)),Input.isUp()&&(e=this.moveIfPossible(DIRECTION.UP)),Input.isLeft()&&(f=this.moveIfPossible(DIRECTION.LEFT)),Input.isRight()&&(g=this.moveIfPossible(DIRECTION.RIGHT))),a=d||e||f||g){var h=void 0;d&&(h=DIRECTION.DOWN),e&&(h=DIRECTION.UP),f&&(h=DIRECTION.LEFT),g&&(h=DIRECTION.RIGHT),a.gameObject.onCollected&&a.gameObject.onCollected(this,a,h),Input.isAction()&&a.transformInto(Game.getSettings().defaultGameObject)}this.isMoving()||(Input.isRight()&&(a=this.getObject(DIRECTION.RIGHT),a.gameObject.canBePushed&&a.gameObject.canBePushed.horizontal&&(this.animate(ANIMATION.PUSH_RIGHT),!a.canMove(DIRECTION.RIGHT)||a.gameObject.canFall&&a.canMove(DIRECTION.DOWN)||Maybe(function(){a.move(DIRECTION.RIGHT),b.move(DIRECTION.RIGHT)},1-a.gameObject.canBePushed.friction))),Input.isLeft()&&(a=this.getObject(DIRECTION.LEFT),a.gameObject.canBePushed&&a.gameObject.canBePushed.horizontal&&(this.animate(ANIMATION.PUSH_LEFT),!a.canMove(DIRECTION.LEFT)||a.gameObject.canFall&&a.canMove(DIRECTION.DOWN)||Maybe(function(){a.move(DIRECTION.LEFT),b.move(DIRECTION.LEFT)},1-a.gameObject.canBePushed.friction))),Input.isUp()&&(a=this.getObject(DIRECTION.UP),a.gameObject.canBePushed&&a.gameObject.canBePushed.vertical&&(this.animate(ANIMATION.PUSH_UP),a.canMove(DIRECTION.UP)&&Maybe(function(){a.move(DIRECTION.UP),b.move(DIRECTION.UP)},1-a.gameObject.canBePushed.friction))),Input.isDown()&&(a=this.getObject(DIRECTION.DOWN),a.gameObject.canBePushed&&a.gameObject.canBePushed.vertical&&(this.animate(ANIMATION.PUSH_DOWN),a.canMove(DIRECTION.DOWN)&&Maybe(function(){a.move(DIRECTION.DOWN),b.move(DIRECTION.DOWN)},1-a.gameObject.canBePushed.friction))))}else if(c.canFall&&this.moveIfPossible(DIRECTION.DOWN),!this.isMoving()&&!this.wasMoving()&&c.canFall&&!this.getObject(DIRECTION.DOWN).gameObject.isStableSurface){var i=this.canMove(DIRECTION.LEFTDOWN),j=this.canMove(DIRECTION.RIGHTDOWN);i&&j&&this.move(Game.getRandomHorizontalDirection()),this.isMoving()||(i&&this.move(DIRECTION.LEFT),j&&this.move(DIRECTION.RIGHT))}if(this.wasMoving()&&!this.isMoving()&&this.wasMovingToDirection==DIRECTION.DOWN){var a=this.getObject(DIRECTION.DOWN);c.onFallen&&c.onFallen(this,a),a.gameObject.onHit&&a.gameObject.onHit(this,DIRECTION.DOWN,a)}c.eachStep&&c.eachStep(this),this.processed=!0}}},MapPosition.prototype.fullStep=function(a){if(this.next){for(key in this.next)this[key]=this.next[key];this.gameObject=GameObjects[this.id],this.staticFrame=this.gameObject.getStaticFrame(),this.wasMovingToDirection=this.movingInToDirection,this.id==GameObjects.PLAYER.id&&Map.setPlayerObject(this),this.animation=!1,this.previousObject&&this.setNext("previousObject",void 0)}else this.wasMovingToDirection=void 0;this.animation&&(this.animation.length>this.animationStartFrame+a+1?this.animationStartFrame=this.animationStartFrame+a+1:this.animation=!1),this.reset(),this.action&&(this.action(this),this.action=void 0)},MapPosition.prototype.reset=function(){this.moveDirection=void 0,this.next=void 0,this.movingInToDirection=void 0,this.processed=!1},MapPosition.prototype.setNext=function(a,b){this.next=this.next||{},this.next[a]=b},MapPosition.prototype.getObject=function(a){switch(a){case DIRECTION.DOWN:return map[this.index+Game.getLevel().width];case DIRECTION.UP:return map[this.index-Game.getLevel().width];case DIRECTION.LEFT:return map[this.index-1];case DIRECTION.RIGHT:return map[this.index+1];case DIRECTION.LEFTDOWN:return map[this.index-1+Game.getLevel().width];case DIRECTION.RIGHTDOWN:return map[this.index+1+Game.getLevel().width];case DIRECTION.LEFTUP:return map[this.index-1-Game.getLevel().width];case DIRECTION.RIGHTUP:return map[this.index+1-Game.getLevel().width];case DIRECTION.NONE:return map[this.index]}},MapPosition.prototype.canMove=function(a){if(this.isMoving())return!1;var b;if(a>100){if(a==DIRECTION.LEFTDOWN){var c=this.getObject(DIRECTION.LEFT),d=this.getObject(DIRECTION.LEFTDOWN);if(c.next||d.next)return!1;if(this.gameObject.canMoveTo(c,DIRECTION.LEFT)&&this.gameObject.canMoveTo(d,DIRECTION.DOWN))return!0}if(a==DIRECTION.RIGHTDOWN){var e=this.getObject(DIRECTION.RIGHT),d=this.getObject(DIRECTION.RIGHTDOWN);if(e.next||d.next)return!1;if(this.gameObject.canMoveTo(e,DIRECTION.RIGHT)&&this.gameObject.canMoveTo(d,DIRECTION.DOWN))return!0}}else{var b=this.getObject(a);if(b){if(b.next&&b.next.id)return!1;if(this.gameObject.canMoveTo(b,a))return!0}else console.error("could not get object in direction"+a,this)}return!1},MapPosition.prototype.canMoveLeft=function(){return this.canMove(DIRECTION.LEFT)},MapPosition.prototype.canMoveRight=function(){return this.canMove(DIRECTION.RIGHT)},MapPosition.prototype.canMoveUp=function(){return this.canMove(DIRECTION.UP)},MapPosition.prototype.canMoveDown=function(){return this.canMove(DIRECTION.DOWN)},MapPosition.prototype.isMoving=function(){return!!this.moveDirection},MapPosition.prototype.wasMoving=function(){return!!this.wasMovingToDirection},MapPosition.prototype.sameDirection=function(){return this.wasMovingToDirection},MapPosition.prototype.move=function(a){this.moveDirection=a;var b=this.nextObjectId||0;this.setNext("id",b),this.nextObjectId=void 0,this.animate(a),this.onMove&&(this.onMove(this),this.onMove=void 0);var c=this.getObject(a);return c.setNext("id",this.id),c.setNext("_objectProperties",this._objectProperties),c.movingInToDirection=a,c},MapPosition.prototype.moveIfPossible=function(a){return this.canMove(a)?this.move(a):!1},MapPosition.prototype.moveLeftIfPossible=function(){this.moveIfPossible(DIRECTION.LEFT)},MapPosition.prototype.moveRightIfPossible=function(){this.moveIfPossible(DIRECTION.RIGHT)},MapPosition.prototype.moveUpIfPossible=function(){this.moveIfPossible(DIRECTION.UP)},MapPosition.prototype.moveDownIfPossible=function(){this.moveIfPossible(DIRECTION.DOWN)},MapPosition.prototype.animate=function(a){"string"==typeof a||"number"==typeof a?(this.animation=this.gameObject[a],this.animation||(this.animation=this.gameObject["animation"+a]),this.animation||(this.animation=this.gameObject.animationFrames[a]),this.animation||(this.animation=this.gameObject.animationFrames["animation"+a])):this.animation=a,this.animationStartFrame=0},MapPosition.prototype.zapIfPossible=function(a){var b=!1;return this.canMove(a)&&(b=this.getObject(a)),b},MapPosition.prototype.animateIfPossible=function(a){this.isAnimating()||this.animate(a)},MapPosition.prototype.isAnimating=function(){return this.animation},MapPosition.prototype.refresh=function(){this.setNext("id",this.id)},MapPosition.prototype.transformInto=function(a,b,c){this.setNext("id",a.id),b&&this.animate(b),c&&this.setNext("action",c)},MapPosition.prototype.addLayer=function(a,b){"bottom"==b?(this.bottomlayer=a,MapLayers[0].add(this)):this.toplayer=a},MapPosition.prototype.removeLayer=function(a){"bottom"==a?(this.bottomlayer=void 0,MapLayers[0].remove(this)):this.toplayer=void 0},MapPosition.prototype.hasLayer=function(a){return"bottom"==a?void 0!=this.bottomlayer:void 0!=this.toplayer},MapPosition.prototype.objectProperties=function(){return this._objectProperties=this._objectProperties||{},this._objectProperties},MapPosition.prototype.getExplodeIntoObjects=function(){var a=Game.getSettings().defaultGameObject;return this.gameObject.explodeIntoObjects&&(a=this.gameObject.explodeIntoObjects()),this.gameObject.explodeIntoObject&&(a=this.gameObject.explodeIntoObject),a};var Game=function(){function a(){var b=n.originalViewPortWidth*n.tileSize,c=n.originalViewPortHeight*n.tileSize,d=window.innerHeight/window.innerWidth;switch(n.scaling){case SCALING.FIT_WIDTH:c=d*b;break;case SCALING.FIT_HEIGHT:d=window.innerWidth/window.innerHeight,b=d*c;break;case SCALING.CONTAIN:var e=Math.ceil(d*b/n.tileSize);e<n.originalViewPortHeight?(d=window.innerWidth/window.innerHeight,b=d*c):c=d*b}if(n.viewPortWidth=Math.ceil(b/n.tileSize),n.viewPortHeight=Math.ceil(c/n.tileSize),n.canvasWidth=b,n.canvasHeight=c,canvas.width=b,canvas.height=c,q&&q.setPosition(),r&&r.setPosition(),F.left=0,F.top=0,F.hintTop=0,F.hintLeft=150,n.showFPS&&(F.left=200,F.hintLeft=350,400>b&&(F.left=0,F.top=24,F.hintLeft=0,F.hintTop=48)),navigator.isCocoonJS)UI.setScale(1,1);else{ctx.webkitImageSmoothingEnabled=ctx.imageSmoothingEnabled=ctx.mozImageSmoothingEnabled=ctx.oImageSmoothingEnabled=!1,canvas.style.width=window.innerWidth+"px",canvas.style.height=window.innerHeight+"px";var f=parseInt(canvas.style.width)/canvas.width,g=parseInt(canvas.style.height)/canvas.height;UI.setScale(f,g)}Map.onResize(n),window.addEventListener("resize",a,!1)}function b(a){var d=a-t;d>y&&(c(),m=1e3/(a-t),t=a),l=1e3/(a-u),u=a,n.showScore&&i(),n.showFPS&&h(),n.showHint&&j(),requestAnimFrame(b)}function c(){G()}function d(){z++,z>=w&&(z=0),0==z&&e();var a=Map.getScrollOffset();f(z,a),z==w-1&&g(z)}function e(){var a=Map.getPlayerObject();a&&a.process();for(var b=Map.getLevelProperties(),c=0,d=b.height*b.width;d>c;c++){var e=map[c];e.process()}Map.initScroll()}function f(a,b){if(ctx.fillStyle=o,ctx.fillRect(0,0,canvas.width,canvas.height),p){var c=0-b.tileX*k+b.x*a,d=0-b.tileY*k+b.y*a;ctx.drawImage(p,c,d)}for(var e=Map.getLevelProperties(),f=0,g=MapLayers.length;g>f;f++){var h=MapLayers[f];h.render(a,b)}for(var i=0,j=e.height*e.width;j>i;i++){var l=map[i];l.isVisible(b)&&l.render(a,b)}var m=Map.getPlayerObject();m&&m.render(a,b),UI.renderElements()}function g(a){for(var b=Map.getLevelProperties(),c=0,d=b.height*b.width;d>c;c++){var e=map[c];e.fullStep(a)}Map.fullStep(a)}function h(){var a=0;if(!isNaN(m)){x.push(m),x.length>60&&x.shift();for(var b=0,c=0;c<x.length;c++)b+=x[c];a=Math.round(b/x.length)}ctx.fillStyle="Black",ctx.fillRect(0,0,200,24),ctx.fillStyle="White",ctx.font="normal 10pt Arial",ctx.fillText(Math.round(l)+" frames/s , "+Math.round(m)+" ticks/s + ("+a+")",10,16)}function i(){ctx.fillStyle="Black",ctx.fillRect(F.left,F.top,200,24),ctx.fillStyle="White",ctx.font="normal 10pt Arial",ctx.fillText("Score: "+A,F.left+10,F.top+16),ctx.fillText("Needed: "+C,F.left+80,F.top+16)}function j(){ctx.fillStyle="Black",ctx.fillRect(F.hintLeft,F.hintTop,200,24),ctx.fillStyle="White",ctx.font="normal 10pt Arial",ctx.fillText(B,F.hintLeft+10,F.hintTop+16)}var k,l,m,n,o,p,q,r,s={},t=0,u=0,v=35,w=4,x=[],y=1e3/v,z=-1,A=0,B="Good luck!",C=0,D=!1,E=!1,F={top:0,left:0},G=function(){};s.init=function(b){n=b;var c=(new Date).getTime();if(n.seed=c,canvas=document.createElement("canvas"),navigator.isCocoonJS,ctx=canvas.getContext("2d"),b.scaling)n.originalViewPortWidth=b.viewPortWidth,n.originalViewPortHeight=b.viewPortHeight,a();else{var d=b.viewPortWidth*b.tileSize,e=b.viewPortHeight*b.tileSize;canvas.width=d,canvas.height=e}document.body.appendChild(canvas),k=b.tileSize,b.borderScrollOffset=8,UI.init(),GameObjects.init(),n.defaultGameObject=GameObjects[n.defaultGameObject],Map.init(b),loadResources(b.spriteSheet,function(){if(n.backgroundPattern&&isNumeric(n.backgroundPattern)&&(o=ctx.createPattern(sprites[n.backgroundPattern],"repeat")),o||(o="Black"),n.backgroundImage){var a=new Image;a.onload=function(){p=document.createElement("canvas"),p.width=2048,p.height=1024;var b=p.getContext("2d");b.globalAlpha=n.backgroundImageAlpha||1,b.drawImage(a,0,0),H()},a.src=n.backgroundImage}else H()})};var H=function(){n.start?n.start():n.level?s.loadLevel(n.level):console.error("nothing to do!"),b()};return s.start=function(){UI.removeAllElements(),n.showOnScreenControls&&(q=new UI.GameController(n.onScreenControlsImage),UI.addElement(q)),r=new UI.Button("resources/close_button.png"),r.onClick=function(){s.exit()},UI.addElement(r),s.resetScore(),s.isWon(!1),s.isLost(!1),s.setHint("Good luck!"),s.setGameSection(d)},s.exit=function(){Intro.init()},s.loadLevel=function(a){console.error("loading level ",a),"string"==typeof a?Map.loadFromUrl(a,function(){s.start()}):"random"==a.map&&(map=Map.generateRandom(a),s.start())},s.getTileSize=function(){return k},s.getTargetTicksPerSecond=function(){return w},s.getViewPort=function(){return{width:n.viewPortWidth,height:n.viewPortHeight}},s.getCanvasSize=function(){return{width:n.canvasWidth,height:n.canvasHeight}},s.getLevel=function(){return level},s.setLevel=function(a){level=a},s.getSettings=function(){return n},s.getRandomDirection=function(){return DIRECTION.LEFT+Math.floor(4*random())},s.getRandomHorizontalDirection=function(){return random()<=.5?DIRECTION.LEFT:DIRECTION.RIGHT},s.getDirectionTurnedLeft=function(a){var b=a-1;return b<DIRECTION.LEFT&&(b=DIRECTION.DOWN),b},s.getDirectionTurnedRight=function(a){var b=a+1;return b>DIRECTION.DOWN&&(b=DIRECTION.LEFT),b},s.getDirectionName=function(a){switch(a){case DIRECTION.LEFT:return"Left";case DIRECTION.RIGHT:return"Right";case DIRECTION.UP:return"Up";case DIRECTION.DOWN:return"Down";default:return"none"}},s.setTargetScore=function(a){C=a},s.addScore=function(a){A+=a},s.resetScore=function(){A=0,console.error("resetscore"),GameObjects.resetState()},s.setHint=function(a){B=a},s.hasTargetScore=function(){return A>=C},s.isWon=function(a){return a&&(D=a),D&&(console.error("WON!"),B="You made it!"),D},s.isLost=function(a){return a&&(E=a),E&&(console.error("FORGET IT!"),B="Forget it!"),E},s.setGameSection=function(a){G=a},s}(),Input=function(){function a(a){var b=a.keyCode;b==i.down&&(c=!0),b==i.left&&(e=!0),b==i.right&&(f=!0),b==i.up&&(d=!0),b==i.space&&(g=!0),b==i.ctrl&&(g=!0)}function b(a){var b=a.keyCode;b==i.down&&(c=!1),b==i.left&&(e=!1),b==i.right&&(f=!1),b==i.up&&(d=!1),b==i.space&&(g=!1),b==i.ctrl&&(g=!1),b==i.up}var c,d,e,f,g,h={},i={left:37,up:38,right:39,down:40,space:32,ctrl:17};return document.addEventListener("keydown",a,!1),document.addEventListener("keyup",b,!1),h.isDown=function(a){return"undefined"!=typeof a&&(c=a),c},h.isUp=function(a){return"undefined"!=typeof a&&(d=a),d},h.isLeft=function(a){return"undefined"!=typeof a&&(e=a),e},h.isRight=function(a){return"undefined"!=typeof a&&(f=a),f},h.isAction=function(a){return"undefined"!=typeof a&&(g=a),g},h}(),Map=function(){var a,b,c,d,e={},f=0,g=0,h=0,i=0,j=0,k=10,l=10;e.init=function(a){l=a.viewPortHeight,k=a.viewPortWidth,c=a.borderScrollOffset},e.onResize=function(a){k=a.viewPortWidth,l=a.viewPortHeight,d&&(h=Math.max(d.left-10,0),i=Math.max(d.top-10,0))},e.getScrollOffset=function(){return{x:f,y:g,tileX:h,tileY:i}},e.setPlayerObject=function(a){d=a},e.getPlayerObject=function(){return d},e.initScroll=function(){d&&(h+k-d.left<c&&d.moveDirection==DIRECTION.RIGHT&&m(DIRECTION.LEFT),d.left-h<c&&d.moveDirection==DIRECTION.LEFT&&m(DIRECTION.RIGHT),i+l-d.top<c&&d.moveDirection==DIRECTION.DOWN&&m(DIRECTION.UP),d.top-i<c&&d.moveDirection==DIRECTION.UP&&m(DIRECTION.DOWN))};var m=function(a){switch(j=a,f=0,g=0,a){case DIRECTION.LEFT:f=-8;break;case DIRECTION.RIGHT:f=8;break;case DIRECTION.DOWN:g=8;break;case DIRECTION.UP:g=-8}};return e.fullStep=function(){switch(j){case DIRECTION.LEFT:h++;break;case DIRECTION.RIGHT:h--;break;case DIRECTION.DOWN:i--;break;case DIRECTION.UP:i++}j=DIRECTION.NONE,f=0,g=0},e.generateRandom=function(c){console.error("random map"),map=[],a=c.width,b=c.height;for(var d=Math.random()*(a-2)+1,e=Math.random()*(b-2)+1,f=Math.floor(e*a+d),g=0,j=b*a;j>g;g++){var k=GameObjects.KEY,l=g%a,m=Math.floor(g/a);(0==l||l==a-1)&&(k=GameObjects.STEELWALL),(0==m||m==b-1)&&(k=GameObjects.STEELWALL),g==f&&(k=GameObjects.PLAYER,h=Math.max(l-10,0),i=Math.max(m-10,0));var n=new MapPosition(k,g);map.push(n)}return map},e.parse=function(c){map=[],MapLayers=[],MapLayers.push(new MapLayer({type:MAPLAYERTYPE.SPOT}));var d=0,e=1;c.mapStructure&&c.mapStructure.charCount&&(e=c.mapStructure.charCount),Game.setTargetScore(c.minimumScore||0),b=c.map.length;for(var f=0;b>f;f++){var g=c.map[f];a=g.length/e;for(var j=0;a>j;j++){d=f*a+j;for(var k="",l=0;e>l;l++)k+=g[j*e+l];var m=GameObjects[k]||Game.getSettings().defaultGameObject,n=new MapPosition(m,d);m.id==GameObjects.PLAYER.id&&(Map.setPlayerObject(n),h=Math.max(j-10,0),i=Math.max(f-10,0)),map.push(n)}}return map},e.loadFromUrl=function(a,b){loadUrl(a,function(a){Game.setLevel(a),map=e.parse(a),b&&b()})},e.getLevelProperties=function(){return{width:a,height:b}},e}(),loadResources=function(a,b){var c=new Image;c.onload=function(){for(var a=Game.getSettings().tileSize,d=Math.floor(c.width/a)*Math.floor(c.height/a),e=0;d>e;e++){var f=new Sprite(e,c,Game.getSettings().tileSize);sprites.push(f)}b&&b()},c.src=a},Sprite=function(a,b,c){var d=Math.floor(b.width/c),e=document.createElement("canvas");e.width=c,e.height=c;var f=e.getContext("2d"),g=a%d,h=Math.floor(a/d);return f.drawImage(b,g*c,h*c,c,c,0,0,c,c),e},UI=function(){function a(a){var b,d;a.touches&&a.touches.length>0?(b=a.touches[0].clientX,d=a.touches[0].clientY):(b=a.pageX,d=a.pageY);var e=b/g,f=d/h;c=UI.getEventElement(e,f),i.isTouchDown=!0,i.x=e,i.y=f,i.startX=e,i.startY=f,i.object=c,c&&c.element&&c.element.onDown&&c.element.onDown(i)}function b(a){var b,d;a.touches&&a.touches.length>0?(b=a.touches[0].clientX,d=a.touches[0].clientY):(b=a.pageX,d=a.pageY);var e=b/g,f=d/h;i.x=e,i.y=f,i.isTouchDown&&c&&c.element&&c.element.onDrag&&c.element.onDrag(i)}var c,d,e={},f=[],g=1,h=1,i={};e.init=function(){canvas.addEventListener("mousedown",a,!1),canvas.addEventListener("mousemove",b,!1),canvas.addEventListener("mouseup",j,!1),canvas.addEventListener("touchstart",a,!1),canvas.addEventListener("touchmove",b,!1),canvas.addEventListener("touchend",j,!1)},e.registerEventElement=function(a,b,c,e,f){d.push({element:a,top:c,right:e,bottom:f,left:b})},e.getEventElement=function(a,b){for(var c,e=0,f=d.length;f>e;e++){var g=d[e];a>=g.left&&a<=g.right&&b>=g.top&&b<=g.bottom&&(c=g)}return c},e.clear=function(a){a=a||"Black",ctx.fillStyle=a,ctx.fillRect(0,0,canvas.width,canvas.height),d=[]},e.removeAllElements=function(){f=[]},e.addElement=function(a){f.push(a)},e.renderElements=function(){for(var a=0,b=f.length;b>a;a++){var c=f[a];c.render()}},e.setScale=function(a,b){g=a,h=b};var j=function(){if(c&&c.element){var a=c.element;a.onClick&&a.onClick(i),a.onUp&&a.onUp(i)}c=void 0,i={},Input.isDown(!1),Input.isUp(!1),Input.isLeft(!1),Input.isRight(!1)};return e}(),requestAnimFrame=function(){return window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(a){window.setTimeout(function(){a(+new Date)},1e3/60)}}(),cancelAnimFrame=function(){return window.cancelAnimationFrame||window.webkitCancelAnimationFrame||window.mozCancelAnimationFrame||window.oCancelAnimationFrame||function(a){window.clearTimeout(a)}}();window.performance=window.performance||{},performance.now=function(){return performance.now||performance.mozNow||performance.msNow||performance.oNow||performance.webkitNow||function(){return(new Date).getTime()}}();var randomSeed=1;UI.Button=function(a){var b=this;this.image=new Image,this.image.onload=function(){b.tileSize=this.width,b.imageLoaded=!0,b.setPosition()},this.image.src=a},UI.Button.prototype.setPosition=function(){this.top=10,this.right=canvas.width-10,this.left=this.right-this.tileSize,this.bottom=this.top+this.tileSize},UI.Button.prototype.render=function(){this.imageLoaded&&(ctx.drawImage(this.image,this.left,this.top),UI.registerEventElement(this,this.left,this.top,this.right,this.bottom))},UI.GameController=function(a){var b=this;this.sprites=[],this.state=0,this.image=new Image,this.image.onload=function(){b.tileSize=this.height;for(var a=0;5>a;a++){var c=new Sprite(a,this,b.tileSize);b.sprites.push(c)}b.imageLoaded=!0,b.setPosition()},this.image.src=a,this.onDown=function(a){d(a.x,a.y)},this.onDrag=function(a){d(a.x,a.y)},this.onUp=function(){c()};var c=function(){b.state=DIRECTION.NONE,Input.isLeft(!1),Input.isRight(!1),Input.isUp(!1),Input.isDown(!1)},d=function(a,d){c(),a-=b.left,d-=b.top;var e=16,f=b.tileSize/2;f-e>a&&(Input.isLeft(!0),b.state=DIRECTION.LEFT),a>f+e&&(Input.isRight(!0),b.state=DIRECTION.RIGHT),f-e>d&&(Input.isUp(!0),b.state=DIRECTION.UP),d>f+e&&(Input.isDown(!0),b.state=DIRECTION.DOWN)}},UI.GameController.prototype.setPosition=function(){this.top=canvas.height-150,this.left=10,this.right=this.left+this.tileSize,this.bottom=this.top+this.tileSize},UI.GameController.prototype.render=function(){if(this.imageLoaded){var a=Math.max(this.state-DIRECTION.LEFT+1,0);ctx.drawImage(this.sprites[a],this.left,this.top),UI.registerEventElement(this,this.left,this.top,this.right,this.bottom)}},UI.Listbox=function(a){function b(a,b){return(a?0>a?-1:1:0)==(b?0>b?-1:1:0)}var c=this;this.items=a.items,this.onSelect=a.onSelect,this.scrollOffetY=0,this.scrollDeltaY=0,this.scrollSpeed=0,this.scrollElastic=0,this.scrollHistory=[],this.scrollThreshold=5,this.itemHeight=64,this.minScollPosition=0,this.maxScrollPosition=this.items.length*this.itemHeight-100;for(var d=function(a){var b=a.y-a.startY;c.scrollDeltaY=parseInt(b)},e=function(a){if(Math.abs(c.scrollDeltaY)<c.scrollThreshold)c.onSelect(a.object.element);else{c.scrollElastic=20;var b=0-f()/10,d=c.scrollOffetY+c.scrollDeltaY,e=(1+c.scrollElastic)*c.scrollElastic/2,g=d+e*b;g>c.minScollPosition&&(b=c.minScollPosition-d/e),g<0-c.maxScrollPosition&&(console.log("self.maxScrollPosition",d,g,c.maxScrollPosition),b=(0-d-c.maxScrollPosition)/e),console.log("initialScrollSpeed",b),c.scrollSpeed=b}c.scrollOffetY+=c.scrollDeltaY,c.scrollDeltaY=0,c.scrollHistory=[]},f=function(){var a=0,d=c.scrollHistory;if(d.length>0){var e,f=0,g=[];for(e=0;e<d.length;e++){var h=d[e];if(0==h)g.push(h);else{if(0==f&&(f=h),!b(f,h))break;g.push(h)}}if(g.length>0){var i=0;for(e=0;e<g.length;e++)i+=g[e];a=i/g.length}return a}},g=0,h=this.items.length;h>g;g++)this.items[g].onUp=e,this.items[g].onDrag=d},UI.Listbox.prototype.render=function(){function a(a){b+=d;var e=sprites[4];ctx.drawImage(e,c,b),ctx.fillStyle="White",ctx.font="normal 10pt Arial",ctx.fillText(a.name,c,b+42),UI.registerEventElement(a,c,b,c+60,b+60)}this.scrollOffetY=this.scrollOffetY+this.scrollElastic*this.scrollSpeed;var b=30+this.scrollOffetY+this.scrollDeltaY,c=100,d=this.itemHeight;this.scrollElastic>0&&(this.scrollElastic-=1),this.prevScrollDeltaY=this.prevScrollDeltaY||0;var e=this.prevScrollDeltaY-this.scrollDeltaY;this.scrollHistory.unshift(e),this.scrollHistory.length>10&&this.scrollHistory.pop(),this.prevScrollDeltaY=this.scrollDeltaY;for(var f=0,g=this.items.length;g>f;f++)a(this.items[f])};