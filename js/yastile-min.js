function loadUrl(a,b){a=a+"?t="+(new Date).getTime();var c;try{c=new XMLHttpRequest}catch(d){try{c=new ActiveXObject("Msxml2.XMLHTTP")}catch(d){try{c=new ActiveXObject("Microsoft.XMLHTTP")}catch(d){b({})}}}c.onreadystatechange=function(){if(4==c.readyState){var a=JSON.parse(c.responseText);b(a)}},c.open("GET",a,!0),c.send()}function random(){var a=1e4*Math.sin(randomSeed++);return a-Math.floor(a)}function Maybe(a,b){isNaN(b)&&(b=1),random()<=b&&a()}function typeOf(a){var b=typeof a;return"object"===b&&(a?a instanceof Array&&(b="array"):b="null"),b}function isArray(a){return"array"==typeOf(a)}function isBoolean(a){return"boolean"==typeOf(a)}function isFunction(a){return"function"==typeOf(a)}function isDefined(a){return"undefined"!=typeOf(a)}function isNumeric(a){return!isNaN(a)}function sortByKey(a,b){return a.sort(function(a,c){var d=a[b],e=c[b];return e>d?-1:d>e?1:0})}function getPixelFromImageData(a,b,c){var d=4*(Math.floor(c)*a.width+Math.floor(b)),e=a.data;return[e[d],e[d+1],e[d+2]]}var Game=function(){function a(){var b=m.originalViewPortWidth,c=m.originalViewPortHeight;m.tileSize&&(b*=m.tileSize,c*=m.tileSize);var d=window.innerHeight/window.innerWidth;switch(m.scaling){case SCALING.FIT_WIDTH:c=d*b;break;case SCALING.FIT_HEIGHT:d=window.innerWidth/window.innerHeight,b=d*c;break;case SCALING.CONTAIN:var e=Math.ceil(d*b);m.tileSize&&(e=Math.ceil(d*b/m.tileSize)),m.originalViewPortHeight>e?(d=window.innerWidth/window.innerHeight,b=d*c):c=d*b}if(m.tileSize&&(m.viewPortWidth=Math.ceil(b/m.tileSize),m.viewPortHeight=Math.ceil(c/m.tileSize)),m.canvasWidth=b,m.canvasHeight=c,canvas.width=b,canvas.height=c,p&&p.setPosition(),D.left=0,D.top=0,D.hintTop=0,D.hintLeft=150,m.showFPS&&(D.left=200,D.hintLeft=350,400>b&&(D.left=0,D.top=24,D.hintLeft=0,D.hintTop=48)),navigator.isCocoonJS)UI.setScale(1,1);else{ctx.webkitImageSmoothingEnabled=ctx.imageSmoothingEnabled=ctx.mozImageSmoothingEnabled=ctx.oImageSmoothingEnabled=!1,canvas.style.width=window.innerWidth+"px",canvas.style.height=window.innerHeight+"px";var f=parseInt(canvas.style.width)/canvas.width,g=parseInt(canvas.style.height)/canvas.height;UI.setScale(f,g)}Map.onResize(m),UI.onResize(m),window.addEventListener("resize",a,!1)}function b(a){var d=a-r;d>=w&&(c(),l=1e3/(a-r),r=a),k=1e3/(a-s),s=a,m.showScore&&g(),m.showFPS&&f(),m.showHint&&h(),requestAnimFrame(b)}function c(){F()}function d(){x++,x>=u&&(x=0),Map.process(x),e(x),Map.cleanUp()}function e(a){ctx.fillStyle=n,ctx.fillRect(0,0,canvas.width,canvas.height),o&&ctx.drawImage(o,0,0),Map.render(a),UI.renderElements(),m.showDebug&&i()}function f(){var a=0;if(!isNaN(l)){v.push(l),v.length>60&&v.shift();for(var b=0,c=0;v.length>c;c++)b+=v[c];a=Math.round(b/v.length)}ctx.fillStyle="Black",ctx.fillRect(0,0,200,24),ctx.fillStyle="White",ctx.font="normal 10pt Arial",ctx.fillText(Math.round(k)+" frames/s , "+Math.round(l)+" ticks/s + ("+a+")",10,16)}function g(){ctx.fillStyle="Black",ctx.fillRect(D.left,D.top,200,24),ctx.fillStyle="White",ctx.font="normal 10pt Arial",ctx.fillText("Score: "+y,D.left+10,D.top+16),ctx.fillText("Needed: "+A,D.left+80,D.top+16)}function h(){ctx.fillStyle="Black",ctx.fillRect(D.hintLeft,D.hintTop,200,24),ctx.fillStyle="White",ctx.font="normal 10pt Arial",ctx.fillText(z,D.hintLeft+10,D.hintTop+16)}function i(){for(var a=[],b=0,c=E.length;c>b;b++){var d=E[b];d&&d.type==DEBUGINFOTYPE.RECT&&(ctx.beginPath(),ctx.lineWidth="1",ctx.strokeStyle=d.data[0],ctx.rect(d.data[1],d.data[2],d.data[3],d.data[4]),ctx.closePath(),ctx.stroke()),d.persistent&&a.push(d)}E=a}var j,k,l,m,n,o,p,q={},r=0,s=0,t=35,u=4,v=[],w=Math.floor(1e3/t),x=-1,y=0,z="Good luck!",A=0,B=!1,C=!1,D={top:0,left:0},E=[],F=function(){};q.init=function(b){m=b;var c=(new Date).getTime();if(m.seed=c,b.targetFps&&(t=b.targetFps,w=Math.floor(1e3/t),t>=60&&(w=0)),canvas=document.createElement("canvas"),ctx=canvas.getContext("2d"),b.scaling)m.originalViewPortWidth=b.viewPortWidth,m.originalViewPortHeight=b.viewPortHeight,a();else{var d=b.viewPortWidth,e=b.viewPortHeight;b.tileSize&&(d*=b.tileSize,e*=b.tileSize),canvas.width=d,canvas.height=e}document.body.appendChild(canvas),j=b.tileSize,b.borderScrollOffset=8;var f=[{id:"spritesheet",url:b.spriteSheet}];m.backgroundImage&&f.push({id:"backGroundImage",url:m.backgroundImage}),m.preload&&(f=f.concat(m.preload)),Preloader.init(f,function(){buildSpriteSheet(Resources.images.spritesheet,function(){if(UI.init(),"undefined"!=typeof GameObjects&&(GameObjects.init(),m.defaultGameObject=GameObjects[m.defaultGameObject]),Map.init(b),m.backgroundPattern&&isNumeric(m.backgroundPattern)&&(n=ctx.createPattern(sprites[m.backgroundPattern].canvas,"repeat")),n||(n="Black"),m.backgroundImage){o=document.createElement("canvas"),o.width=2048,o.height=1024;var a=o.getContext("2d");a.globalAlpha=m.backgroundImageAlpha||1,a.drawImage(Resources.images.backGroundImage,0,0),G()}else G()})})};var G=function(){m.start?m.start():m.level&&q.loadLevel(m.level),b()};return q.start=function(){if(UI.removeAllElements(),m.showOnScreenControls){p=new UI.GameController(m.onScreenControls),UI.addElement(p);var a=new UI.Button({id:"action",url:m.actionButtonImage,bottom:canvas.height-40,right:canvas.width-20,width:74,height:74,states:[[0,0,74,74],[79,0,74,74]],onDown:function(){Input.isAction(!0),this.setSate(1)},onUp:function(){Input.isAction(!1),this.setSate(0)},onResize:function(a){a.right=canvas.width-20,a.left=a.right-a.width,a.bottom=canvas.height-40,a.top=a.bottom-a.height}});UI.addElement(a)}var b=new UI.Button({id:"close",url:m.closeButtonImage,top:10,right:canvas.width-10,onClick:function(){q.exit()},onResize:function(a){a.right=canvas.width-10,a.left=a.right-a.width}});UI.addElement(b),q.resetScore(),q.isWon(!1),q.isLost(!1),q.setHint("Good luck!"),q.setGameSection(d)},q.exit=function(){Intro.init()},q.loadLevel=function(a){"string"==typeof a&&Map.loadFromUrl(a,function(){q.start()})},q.addDebugRect=function(a,b,c,d,e,f){q.addDebugInfo(DEBUGINFOTYPE.RECT,[a,b,c,d,e],f)},q.addDebugInfo=function(a,b,c){E.push({type:a,data:b,persistent:c})},q.getTileSize=function(){return j},q.getTargetTicksPerSecond=function(){return u},q.getViewPort=function(){return{width:m.viewPortWidth,height:m.viewPortHeight}},q.getCanvasSize=function(){return{width:m.canvasWidth,height:m.canvasHeight}},q.getSettings=function(){return m},q.getRandomDirection=function(){return DIRECTION.LEFT+Math.floor(4*random())},q.getRandomHorizontalDirection=function(){return random()<=.5?DIRECTION.LEFT:DIRECTION.RIGHT},q.getDirectionTurnedLeft=function(a){var b=a-1;return DIRECTION.LEFT>b&&(b=DIRECTION.DOWN),b},q.getDirectionTurnedRight=function(a){var b=a+1;return b>DIRECTION.DOWN&&(b=DIRECTION.LEFT),b},q.getDirectionName=function(a){switch(a){case DIRECTION.LEFT:return"Left";case DIRECTION.RIGHT:return"Right";case DIRECTION.UP:return"Up";case DIRECTION.DOWN:return"Down";default:return"none"}},q.setTargetScore=function(a){A=a},q.addScore=function(a){y+=a},q.resetScore=function(){y=0,"undefined"!=typeof GameObjects&&GameObjects.resetState()},q.setHint=function(a){z=a},q.hasTargetScore=function(){return y>=A},q.isWon=function(a){return a&&(B=a),B&&(z="You made it!"),B},q.isLost=function(a){return a&&(C=a),C&&(z="Forget it!"),C},q.setGameSection=function(a){F=a},q}(),Input=function(){function a(a){var b=a.keyCode;b==i.down&&(c=!0),b==i.left&&(e=!0),b==i.right&&(f=!0),b==i.up&&(d=!0),b==i.space&&(g=!0),b==i.ctrl&&(g=!0)}function b(a){var b=a.keyCode;b==i.down&&(c=!1),b==i.left&&(e=!1),b==i.right&&(f=!1),b==i.up&&(d=!1),b==i.space&&(g=!1),b==i.ctrl&&(g=!1)}var c,d,e,f,g,h={},i={left:37,up:38,right:39,down:40,space:32,ctrl:17};return document.addEventListener("keydown",a,!1),document.addEventListener("keyup",b,!1),h.isDown=function(a){return"undefined"!=typeof a&&(c=a),c},h.isUp=function(a){return"undefined"!=typeof a&&(d=a),d},h.isLeft=function(a){return"undefined"!=typeof a&&(e=a),e},h.isRight=function(a){return"undefined"!=typeof a&&(f=a),f},h.isAction=function(a){return"undefined"!=typeof a&&(g=a),g},h}(),Map=function(){var a={},b=[];return a.init=function(){},a.loadFromUrl=function(c,d){b=[];var e;loadUrl(c,function(b){if(b.layers)for(var c=1;b.layers.length>=c;c++){var f=b.layers[c-1];f.id="layer"+c,f.zIndex=c,e=a.addLayer(f)}else b.id="layer1",b.zIndex=1,e=a.addLayer(b);d&&d(e)})},a.addLayer=function(a){var c=void 0;a.type&&(c=a.type),!c&&a.map&&(c=MAPLAYERTYPE.GRID),!c&&a.src&&(c=MAPLAYERTYPE.IMAGE),c||(c=MAPLAYERTYPE.FREE),a.type=c,a.speed=a.speed||1;var d=new MapLayer(a);return b.push(d),d},a.getLayer=function(a){for(var c=0;b.length>c;c++)if(b[c].id==a)return b[c];return void 0},a.onResize=function(){},a.process=function(){for(var a=0;b.length>a;a++)b[a].process()},a.render=function(){for(var a=0;b.length>a;a++)b[a].render()},a.cleanUp=function(){for(var a=0;b.length>a;a++)b[a].cleanUp()},a.sortLayers=function(){sortByKey(b,"zIndex")},a}(),MapLayer=function(a){function b(a){var b=0,c=1;a.mapStructure&&a.mapStructure.charCount&&(c=a.mapStructure.charCount),Game.setTargetScore(a.minimumScore||0),e.levelHeight=a.map.length,e.activeObjectCount=0,e.inactiveObjectCount=0;for(var d=0;e.levelHeight>d;d++){var f=a.map[d];e.levelWidth=f.length/c;for(var g=0;e.levelWidth>g;g++){b=d*e.levelWidth+g;for(var h="",i=0;c>i;i++)h+=f[g*c+i];var j=GameObjects[h]||Game.getSettings().defaultGameObject,k=new MapPosition(j,b,e);j.id==GameObjects.PLAYER.id&&(e.playerObject=k,e.scrollTilesX=Math.max(g-10,0),e.scrollTilesY=Math.max(d-10,0)),e.objects.push(k),j.inActive?e.inactiveObjectCount++:e.activeObjectCount++}}}if(a.parentLayer){var c=a.parentLayer;a.width=c.width,a.height=c.height,a.speed=c.speed,c.addSubLayer(this)}for(var d in a)this[d]=a[d];this.objects=[],this.sublayers=[],this.activeObjectCount=0,this.inactiveObjectCount=0,this.playerObject=void 0;var e=this;if(this.levelWidth=a.width,this.levelHeight=a.height,this.scrollOffsetX=0,this.scrollOffsetY=0,this.scrollTilesX=0,this.scrollTilesY=a.startY||0,this.scrollPixelX=this.scrollPixelX||0,this.scrollPixelY=this.scrollPixelY||0,this.scrollDirection=0,this.viewPortWidth=10,this.viewPortHeight=10,this.borderScrollOffset=5,this.step=0,this.speed){var f=1/this.speed;this.targetTicksPerSecond=Game.getTargetTicksPerSecond()*f}else this.targetTicksPerSecond=Game.getTargetTicksPerSecond();if(this.tileSize||(this.tileSize=Game.getTileSize()),this.scrollStep=this.tileSize?this.tileSize/this.targetTicksPerSecond:1,isDefined(this.isVisible)||(this.isVisible=!0),this.type==MAPLAYERTYPE.IMAGE){var g=this;if(g.preloadedSrc){var h=Resources.images[g.preloadedSrc];g.sprite=new Sprite(h,"",0,0,h.width,h.height)}else g.src&&(this.image=new Image,this.image.onload=function(){g.sprite=new Sprite(this,"",0,0,this.width,this.height)},this.image.src=g.src)}a.map&&b(a)};MapLayer.prototype.isActive=function(){return this.activeObjectCount>0&&this.isVisible},MapLayer.prototype.process=function(){var a=!0;if(this.type==MAPLAYERTYPE.SPOT&&(a=!1),this.isActive()||(a=!1),this.type==MAPLAYERTYPE.GRID&&0!=this.step&&(a=!1),a){this.playerObject&&this.playerObject.process();for(var b=0,c=this.objects.length;c>b;b++){var d=this.objects[b];d&&d.process()}}this.initScroll()},MapLayer.prototype.addObject=function(a,b){b=b||MAPOBJECTTYPE.GRID,a.objectType=b,a.mapLayer=this,this.objects.push(a),a.inActive||this.activeObjectCount++},MapLayer.prototype.removeObject=function(a){var b=this.objects.indexOf(a);b>=0&&this.objects.splice(b,1)},MapLayer.prototype.clear=function(){this.objects=[]},MapLayer.prototype.getScrollOffset=function(){return this.parentLayer?this.parentLayer.getScrollOffset():{x:this.scrollOffsetX,y:this.scrollOffsetY,tileX:this.scrollTilesX,tileY:this.scrollTilesY,pixelX:this.scrollPixelX,pixelY:this.scrollPixelY}},MapLayer.prototype.setScrollOffset=function(a){this.scrollTilesX=a.tileX||0,this.scrollTilesY=a.tileY||0,this.scrollOffsetX=a.x||0,this.scrollOffsetY=a.y||0,this.scrollPixelX=a.pixelX,this.scrollPixelY=a.pixelY},MapLayer.prototype.render=function(){if(this.step++,this.step>=this.targetTicksPerSecond&&(this.step=0),this.isVisible){if(this.sprite){if(this.tileSize)this.scrollPixelX=this.scrollTilesX*this.tileSize+this.scrollOffsetX*this.step,this.scrollPixelX=this.scrollTilesY*this.tileSize+this.scrollOffsetY*this.step;else var a=0-this.scrollPixelX,b=0-this.scrollPixelY;ctx.drawImage(this.sprite.canvas,a,b)}for(var c=this.getScrollOffset(),d=0,e=this.objects.length;e>d;d++){var f=this.objects[d];f.isVisible(c)&&f.render(this.step,c,0)}}},MapLayer.prototype.cleanUp=function(){switch(this.type){case MAPLAYERTYPE.GRID:if(this.step>=this.targetTicksPerSecond-1){var a=Game.getViewPort();if(this.autoScrollDirection&&this.onEnd){var b=!1;switch(this.autoScrollDirection){case DIRECTION.DOWN:var c=this.height-a.height-2;-c>this.scrollTilesY&&(b=!0);break;case DIRECTION.LEFT:var c=this.width-a.width-2;this.scrollTilesX>c&&(b=!0)}b&&this.onEnd(this)}this.fullStep()}break;case MAPLAYERTYPE.IMAGE:this.step>=this.targetTicksPerSecond-1&&this.fullStep();break;case MAPLAYERTYPE.FREE:for(var d=0,e=this.objects.length;e>d;d++){var f=this.objects[d];f&&f.fullStep()}}},MapLayer.prototype.fullStep=function(){if(this.isActive())for(var a=0,b=this.objects.length;b>a;a++){var c=this.objects[a];c.fullStep(this.step)}switch(this.scrollDirection){case DIRECTION.LEFT:this.scrollTilesX++;break;case DIRECTION.RIGHT:this.scrollTilesX--;break;case DIRECTION.DOWN:this.scrollTilesY--;break;case DIRECTION.UP:this.scrollTilesY++}this.scrollDirection=DIRECTION.NONE,this.scrollOffsetX=0,this.scrollOffsetY=0},MapLayer.prototype.setPlayerObject=function(a){this.playerObject=a},MapLayer.prototype.getPlayerObject=function(){return this.playerObject},MapLayer.prototype.getObjectAtPixels=function(a,b){if(this.type==MAPLAYERTYPE.GRID){var c=Game.getSettings().tileSize,d=Math.floor(a/c),e=Math.floor(b/c);return this.getObjectAtGrid(d,e)}for(var f=[],g=0,h=this.objects.length;h>g;g++){var i=this.objects[g];a>i.left&&i.left+i.width>a&&b>i.top&&i.top+i.height>b&&f.push(i)}return f},MapLayer.prototype.getColorAtPixel=function(a,b){return this.type==MAPLAYERTYPE.IMAGE&&this.sprite?this.sprite.getColorAtPixel(a,b):void 0},MapLayer.prototype.putColorAtPixel=function(a,b,c){this.type==MAPLAYERTYPE.IMAGE&&this.sprite&&this.sprite.putColorAtPixel(a,b,c)},MapLayer.prototype.getObjectAtGrid=function(a,b){var c=b*this.levelWidth+a;return this.objects[c]},MapLayer.prototype.initScroll=function(){if(!this.parentLayer){var a=this;this.playerObject&&(this.borderScrollOffset>this.scrollTilesX+this.viewPortWidth-this.playerObject.left&&this.playerObject.moveDirection==DIRECTION.RIGHT&&a.scroll(DIRECTION.LEFT),this.borderScrollOffset>this.playerObject.left-this.scrollTilesX&&this.playerObject.moveDirection==DIRECTION.LEFT&&a.scroll(DIRECTION.RIGHT),this.borderScrollOffset>this.scrollTilesY+this.viewPortHeight-this.playerObject.top&&this.playerObject.moveDirection==DIRECTION.DOWN&&a.scroll(DIRECTION.UP),this.borderScrollOffset>this.playerObject.top-this.scrollTilesY&&this.playerObject.moveDirection==DIRECTION.UP&&a.scroll(DIRECTION.DOWN)),this.autoScrollDirection&&a.scroll(this.autoScrollDirection)}},MapLayer.prototype.setAutoScroll=function(a){this.autoScrollDirection=a},MapLayer.prototype.scroll=function(a){var b=this.scrollStep;switch(this.scrollDirection=a,this.scrollOffsetX=0,this.scrollOffsetY=0,a){case DIRECTION.LEFT:this.scrollOffsetX=-b;break;case DIRECTION.RIGHT:this.scrollOffsetX=b;break;case DIRECTION.DOWN:this.scrollOffsetY=b;break;case DIRECTION.UP:this.scrollOffsetY=-b}},MapLayer.prototype.addSubLayer=function(a){this.sublayers.push(a)},MapLayer.prototype.removeSubLayer=function(a){for(var b=0,c=this.sublayers.length;c>b;b++)this.sublayers[b].id==a.id&&this.sublayers.splice(b,1)},MapLayer.prototype.show=function(){this.isVisible=!0},MapLayer.prototype.hide=function(){this.isVisible=!1};var MapObject=function(a){for(var b in a)this[b]=a[b];this.id=a.id||this.gameObject.id,this.staticFrame=this.gameObject.getStaticFrame();var c=sprites[this.staticFrame];if(this.height=c.canvas.height,this.width=c.canvas.width,this.rotation=this.rotation||0,this.rotationRadiants=0,this.rotation>0){var d=this.rotation;this.rotation=0,this.rotate(d)}this.gameObject.onCreate&&this.gameObject.onCreate(this)};MapObject.prototype.setStaticFrame=function(a){if(this.staticFrame=a,!isNumeric(this.staticFrame)){var b=spriteNames[this.staticFrame];b>=0&&(this.staticFrame=b)}var c=sprites[this.staticFrame];this.height=c.canvas.height,this.width=c.canvas.width},MapObject.prototype.getCurrentFrame=function(){var a;return this.animation?(this.animationStartFrame++,this.animationStartFrame>=this.animation.length&&(this.animationStartFrame=0),a=this.gameObject.getAnimationFrame(this.animation,this.animationStartFrame).canvas):a=sprites[this.staticFrame].canvas,this.rotation&&(a=sprites[this.staticFrame].rotated[this.rotation],a||(a=sprites[this.staticFrame].canvas)),a},MapObject.prototype.isVisible=function(){return!0},MapObject.prototype.render=function(a,b){var c=b.pixelX,d=b.pixelY;this.mapLayer.tileSize&&(c=b.tileX*this.mapLayer.tileSize-b.x*a,d=b.tileY*this.mapLayer.tileSize-b.y*a);var e=this.left-c,f=this.top-d;if(this.id>0){var g=this.getCurrentFrame();ctx.drawImage(g,e,f)}},MapObject.prototype.process=function(){if(!this.processed){var a=this,b=a.gameObject;b.inActive||(b.isPlayer(),b.eachStep&&b.eachStep(this),this.processed=!0)}},MapObject.prototype.fullStep=function(){this.processed=!1,this.collisionChecked=!1},MapObject.prototype.destroy=function(){this.mapLayer.removeObject(this)},MapObject.prototype.detectCollistion=function(a,b){for(var c=this,d=0;c.mapLayer.objects.length>d;d++){var e=c.mapLayer.objects[d];if(e&&e.id!=this.id&&e.left+e.width>c.left&&c.left+this.width>e.left&&e.top+e.height>c.top&&c.height+c.top>e.top){var f=!0;if(Game.addDebugRect("red",c.left-c.mapLayer.scrollPixelX,c.top-c.mapLayer.scrollPixelY,c.width,c.height,!1),Game.addDebugRect("blue",e.left-c.mapLayer.scrollPixelX,e.top-c.mapLayer.scrollPixelY,e.width,e.height,!1),a){f=!1;var g=Math.max(c.left,e.left),h=c.width-Math.abs(c.left-e.left),i=Math.max(c.top,e.top),j=c.height-Math.abs(c.top-e.top);Game.addDebugRect("yellow",g-c.mapLayer.scrollPixelX,i-c.mapLayer.scrollPixelY,h,j,!1);for(var k=c.getCurrentFrame().getContext("2d").getImageData(g-c.left,i-c.top,h,j).data,l=e.getCurrentFrame().getContext("2d").getImageData(g-e.left,i-e.top,h,j).data,m=0;!f&&h*j*4>m;){var n=100,o=k[m+3],p=l[m+3];o>n&&p>n&&(f=!0),m+=4}}f&&b(e)}}},MapObject.prototype.animate=function(a){"string"==typeof a||"number"==typeof a?(this.animation=this.gameObject[a],this.animation||(this.animation=this.gameObject["animation"+a]),this.animation||(this.animation=this.gameObject.animationFrames[a]),this.animation||(this.animation=this.gameObject.animationFrames["animation"+a])):this.animation=a,this.animationStartFrame=0},MapObject.prototype.animateIfPossible=function(a){this.isAnimating()||this.animate(a)},MapObject.prototype.isAnimating=function(){return this.animation},MapObject.prototype.rotate=function(a){this.rotation=((this.rotation||0)+a)%360,0>this.rotation&&(this.rotation+=360),this.rotationRadiants=this.rotation*Math.PI/180;var b=sprites[this.staticFrame];b.rotated[this.rotation]||b.rotate(this.rotation)};var Resources={images:{}},Preloader=function(){var a,b,c,d,e,f,g={};return g.init=function(h,i){if(e=200,f=10,d=(canvas.width-e)/2,c=(canvas.height-f)/2,b=h.length,0==b)i();else{var j=function(){g.render(),a==b&&i&&i()};g.render(),g.load(h,j)}},g.load=function(c,d){a=0;for(var e,f=0;b>f;f++){var g=c[f];e=g.url?g.url:g;var h=new Image;h.onload=function(){a++,this.id&&(Resources.images[this.id]=this),d&&d()},h.onerror=function(){},h.id=g.id,h.src=e}},g.render=function(){UI.clear(),ctx.strokeStyle="white",ctx.fillStyle="white",ctx.rect(d,c,e,f),ctx.stroke();var g=Math.floor(a*e/b);ctx.fillRect(d,c,g,f)},g}(),Sprite=function(a,b,c,d,e,f){if("undefined"==typeof e){var g=c,h=Math.floor(a.width/g);c=b%h*g,d=Math.floor(b/h)*g,e=g,f=g}var i=document.createElement("canvas");i.width=e,i.height=f;var j=i.getContext("2d");this.canvas=i,this.ctx=j,this.rotated={},this.width=e,this.height=f,j.drawImage(a,c,d,e,f,0,0,e,f)};Sprite.prototype.getColorAtPixel=function(a,b){return this.ctx.getImageData(a,b,1,1).data},Sprite.prototype.putColorAtPixel=function(a,b,c){var d=ctx.createImageData(1,1);if(d){var e=d.data;e[0]=255,e[1]=255,e[3]=255,e[4]=255,this.ctx.putImageData(d,b,c)}},Sprite.prototype.rotate=function(a){a=Math.round(a);var b=document.createElement("canvas");b.width=this.width,b.height=this.height;var c=b.getContext("2d");c.translate(this.width/2,this.height/2),c.rotate(a*Math.PI/180),c.translate(-this.width/2,-this.height/2),c.drawImage(this.canvas,0,0),this.rotated[a]=b};var buildSpriteSheet=function(a,b){var c=Game.getSettings().spriteMap;if(c)for(var d=0;spriteMap.length>d;d++){var e=spriteMap[d],f=a;e.src&&(f=userData[e.src]);var g=new Sprite(f,e.name,e.l,e.t,e.w,e.h);sprites.push(g),spriteNames[e.name]=sprites.length-1}else for(var h=Game.getSettings().tileSize,i=Math.floor(a.width/h)*Math.floor(a.height/h),d=0;i>d;d++){var g=new Sprite(a,d,Game.getSettings().tileSize);sprites.push(g)}b&&b()},UI=function(){function a(a){function b(a,b,c){h.isTouchDown=!0;var d=b/f,e=c/g,i={id:a,x:d,y:e,startX:d,startY:e,UIobject:UI.getEventElement(d,e)};h.touches.push(i),i.UIobject&&i.UIobject.element&&i.UIobject.element.onDown&&i.UIobject.element.onDown(i)}if(a.preventDefault(),a.touches&&a.touches.length>0)for(var c=a.changedTouches,d=0;c.length>d;d++){var e=c[d];b(e.identifier,e.pageX,e.pageY)}else{var j=i("notouch");j>=0&&h.touches.splice(j,1),b("notouch",a.pageX,a.pageY)}}function b(a){function b(a,b,c){if(a>=0){var d=h.touches[a];d.x=b/f,d.y=c/f,h.touches.splice(a,1,d),h.isTouchDown&&d.UIobject&&d.UIobject.element&&d.UIobject.element.onDrag&&d.UIobject.element.onDrag(d)}}if(a.preventDefault(),a.touches&&a.touches.length>0)for(var c=a.changedTouches,d=0;c.length>d;d++){var e=c[d];b(i(e.identifier),e.pageX,e.pageY)}else b(i("notouch"),a.pageX,a.pageY),h.currentMouseX=a.pageX,h.currentMouseY=a.pageY}var c,d={},e=[],f=1,g=1,h={};h.touches=[],d.init=function(){canvas.addEventListener("mousedown",a,!1),canvas.addEventListener("mousemove",b,!1),canvas.addEventListener("mouseup",j,!1),canvas.addEventListener("touchstart",a,!1),canvas.addEventListener("touchmove",b,!1),canvas.addEventListener("touchend",j,!1),canvas.addEventListener("mousewheel",k,!1),canvas.addEventListener("DOMMouseScroll",k,!1),window.navigator.msPointerEnabled&&(canvas.addEventListener("MSPointerDown",a,!1),canvas.addEventListener("MSPointerMove",b,!1),canvas.addEventListener("MSPointerEnd",j,!1))},d.registerEventElement=function(a,b,d,e,f){c.push({element:a,top:d,right:e,bottom:f,left:b})},d.getEventElement=function(a,b){for(var d,e=0,f=c.length;f>e;e++){var g=c[e];a>=g.left&&g.right>=a&&b>=g.top&&g.bottom>=b&&(d=g)}return d},d.clear=function(a){a=a||"Black",ctx.fillStyle=a,ctx.fillRect(0,0,canvas.width,canvas.height),c=[]},d.removeAllElements=function(){e=[],c=[]},d.addElement=function(a){e.push(a)},d.renderElements=function(){for(var a=0,b=e.length;b>a;a++){var c=e[a];c.render()}},d.setScale=function(a,b){f=a,g=b},d.onResize=function(){for(var a=0,b=e.length;b>a;a++){var c=e[a];c.onResize&&c.onResize(c)}};var i=function(a){for(var b=0;h.touches.length>b;b++)if(h.touches[b].id===a)return b;return-1},j=function(a){function b(a){if(a>=0){var b=h.touches[a];if(b.UIobject&&b.UIobject.element){var c=b.UIobject.element;c.onClick&&c.onClick(b),c.onUp&&c.onUp(b)}h.touches.splice(a,1)}}function c(){Input.isDown(!1),Input.isUp(!1),Input.isLeft(!1),Input.isRight(!1)}if(a&&a.touches){for(var d=a.changedTouches,e=0;d.length>e;e++){var f=d[e];b(i(f.identifier))}0==a.touches.length&&c()}else b(i("notouch")),c()},k=function(a){if(h.currentMouseX){var b=a.wheelDelta||-a.detail,c=h.currentMouseX/f,d=h.currentMouseY/g,e=UI.getEventElement(c,d);e&&e.element&&e.element.onMouseWheel&&e.element.onMouseWheel(b)}};return d}(),requestAnimFrame=function(){return window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(a){window.setTimeout(function(){a(+new Date)},1e3/60)}}(),cancelAnimFrame=function(){return window.cancelAnimationFrame||window.webkitCancelAnimationFrame||window.mozCancelAnimationFrame||window.oCancelAnimationFrame||function(a){window.clearTimeout(a)}}();window.performance=window.performance||{},performance.now=function(){return performance.now||performance.mozNow||performance.msNow||performance.oNow||performance.webkitNow||function(){return(new Date).getTime()}}();var randomSeed=1,V=function(a,b){this.x=a,this.y=b};V.prototype.add=function(a){return new V(a.x+this.x,a.y+this.y)},V.prototype.subtract=function(a){return new V(this.x-a.x,this.y-a.y)},V.prototype.scale=function(a){return new V(this.x*a,this.y*a)},V.prototype.dot=function(a){return this.x*a.x+this.y*a.y},V.prototype.cross=function(a){return this.x*a.y-this.y*a.x},V.prototype.rotate=function(a,b){"undefined"==typeof b&&(b=new V(0,0));var c=this.x-b.x,d=this.y-b.y,e=b.x+(c*Math.cos(a)-d*Math.sin(a)),f=b.y+(c*Math.sin(a)+d*Math.cos(a));return new V(e,f)},V.prototype.copy=function(){return new V(this.x,this.y)};var canvas,ctx,map=[],sprites=[],spritesRotated={},spriteNames={},DIRECTION={LEFT:37,UP:38,RIGHT:39,DOWN:40,LEFTUP:3738,RIGHTUP:3938,LEFTDOWN:3740,RIGHTDOWN:3940,NONE:0},DIRECTION_OPPOSITE={37:DIRECTION.RIGHT,38:DIRECTION.DOWN,39:DIRECTION.LEFT,40:DIRECTION.UP},ANIMATION={PUSH_RIGHT:"PushRight",PUSH_LEFT:"PushLeft",PUSH_UP:"PushUp",PUSH_DOWN:"PushDown"},SCALING={NONE:0,FIT_WIDTH:1,FIT_HEIGHT:2,CONTAIN:3,STRETCH:4},MAPLAYERTYPE={GRID:1,SPOT:2,FREE:3,IMAGE:4},MAPOBJECTTYPE={GRID:1,FIXED:2,FREE:3},DEBUGINFOTYPE={RECT:1,TEXT:2},ONSCREENCONTROLS={_4WAY:{image:"../../resources/controller_4way.png",input:4},_2WAY:{image:"../../resources/controller_2way.png",input:2}},GameObjectIndex=[],GameObject=function(a){var b=!1;for(var c in a)this[c]=a[c],"function"==typeof a[c]&&(b=!0);if(this.setDefault("canMove",!1),this.setDefault("canBeCollected",!1),this.setDefault("canFall",!1),this.setDefault("isStableSurface",!0),this.canFall&&this.setDefault("onFallen",function(a,b){!b.isMoving()&&b.gameObject.canBeCrushedBy&&b.gameObject.canBeCrushedBy(a)&&(a.move(DIRECTION.DOWN),b.gameObject.onCrushed&&b.gameObject.onCrushed(a,b))}),this.spriteIndex=this.id,a.spriteIndex&&(this.spriteIndex=a.spriteIndex),this.spriteIndexes=a.spriteIndexes,!isNumeric(this.spriteIndex)){var d=spriteNames[this.spriteIndex];d>=0&&(this.spriteIndex=d)}if(this.animationFrames={},a.animationRight&&(this.animationFrames[DIRECTION.RIGHT]=a.animationRight),a.animationLeft&&(this.animationFrames[DIRECTION.LEFT]=a.animationLeft),a.animationUp&&(this.animationFrames[DIRECTION.UP]=a.animationUp),a.animationDown&&(this.animationFrames[DIRECTION.DOWN]=a.animationDown),this.isGameObject=!0,this.inActive=!(this.canMove||this.canFall||b),GameObjects[this.id]=this,GameObjects[this.code]=this,GameObjectIndex.push(this),this.alias)if("string"==typeof this.alias)GameObjects[this.alias]=this;else for(var e=0;this.alias.length>e;e++)GameObjects[this.alias[e]]=this};GameObject.prototype.getAnimationFrame=function(a,b){var c=this.spriteIndex;if(a){var d=Math.min(b,a.length-1);c=a[d]}return sprites[c]},GameObject.prototype.getStaticFrame=function(){var a=this.spriteIndex;return this.spriteIndexes&&this.spriteIndexes.length>0&&(a=this.spriteIndexes[Math.floor(Math.random()*this.spriteIndexes.length)]),a},GameObject.prototype.isEmpty=function(){return 0==this.id},GameObject.prototype.isPlayer=function(){return GameObjects.PLAYER&&this.id==GameObjects.PLAYER.id},GameObject.prototype.setDefault=function(a,b){"undefined"==typeof this[a]&&(this[a]=b)},GameObject.prototype.canMoveTo=function(a,b){if(!a)return!1;var c=a.gameObject;if(c.isEmpty())return!0;if(this.isPlayer()&&c.canBeCollected){if(isBoolean(c.canBeCollected))return!0;if(isFunction(c.canBeCollected)&&c.canBeCollected(a))return!0}if(c.isPlayer()){if(a.moveDirection){var d=DIRECTION_OPPOSITE[a.moveDirection];if(b!=d)return!0}if(c.canBeCollectedBy(this,a))return!0}return!1};var MapPosition=function(a,b,c){this.gameObject=a,this.id=a.id,this.index=b,this.staticFrame=a.getStaticFrame(),this.mapLayer=c,this.left=b%c.levelWidth,this.top=Math.floor(b/c.levelWidth),this.tileSize=Game.getTileSize(),this.tickOffset=this.tileSize/Game.getTargetTicksPerSecond()};MapPosition.prototype.isVisible=function(a){return this.left>=a.tileX-1&&this.left<a.tileX+Game.getViewPort().width+1&&this.top>=a.tileY-1&&this.top<a.tileY+Game.getViewPort().height+1},MapPosition.prototype.render=function(a,b,c){var d=(this.left-b.tileX)*this.tileSize,e=(this.top-b.tileY)*this.tileSize;isDefined(c)||(c=1),d+=b.x*a,e+=b.y*a;var f=d,g=e;if(this.moveDirection==DIRECTION.DOWN&&(e+=a*this.tickOffset),this.moveDirection==DIRECTION.UP&&(e-=a*this.tickOffset),this.moveDirection==DIRECTION.LEFT&&(d-=a*this.tickOffset),this.moveDirection==DIRECTION.RIGHT&&(d+=a*this.tickOffset),this.bottomlayer&&"bottom"==this.mapLayer.id)h=sprites[this.bottomlayer].canvas,ctx.drawImage(h,f,g);else{if(this.id>0){var h;h=this.animation?this.gameObject.getAnimationFrame(this.animation,a+this.animationStartFrame).canvas:sprites[this.staticFrame].canvas,ctx.drawImage(h,d,e)}this.toplayer&&(h=sprites[this.toplayer].canvas,ctx.drawImage(h,f,g))}},MapPosition.prototype.process=function(){if(!this.processed){var a,b=this,c=b.gameObject;if(!c.inActive){if(c.isPlayer()){var d,e,f,g;if(Input.isAction()?(this.actionDownCount=(this.actionDownCount||0)+1,this.actionDownCount>5&&this.gameObject.onLongPress&&this.gameObject.onLongPress(this),Input.isDown()&&(d=this.zapIfPossible(DIRECTION.DOWN)),Input.isUp()&&(e=this.zapIfPossible(DIRECTION.UP)),Input.isLeft()&&(f=this.zapIfPossible(DIRECTION.LEFT)),Input.isRight()&&(g=this.zapIfPossible(DIRECTION.RIGHT))):(this.actionDownCount=0,Input.isDown()&&(d=this.moveIfPossible(DIRECTION.DOWN)),Input.isUp()&&(e=this.moveIfPossible(DIRECTION.UP)),Input.isLeft()&&(f=this.moveIfPossible(DIRECTION.LEFT)),Input.isRight()&&(g=this.moveIfPossible(DIRECTION.RIGHT))),a=d||e||f||g){var h=void 0;d&&(h=DIRECTION.DOWN),e&&(h=DIRECTION.UP),f&&(h=DIRECTION.LEFT),g&&(h=DIRECTION.RIGHT),a.gameObject.onCollected&&a.gameObject.onCollected(this,a,h),Input.isAction()&&a.transformInto(Game.getSettings().defaultGameObject)}this.isMoving()||(Input.isRight()&&(a=this.getObject(DIRECTION.RIGHT),a.gameObject.canBePushed&&a.gameObject.canBePushed.horizontal&&(this.animate(ANIMATION.PUSH_RIGHT),!a.canMove(DIRECTION.RIGHT)||a.gameObject.canFall&&a.canMove(DIRECTION.DOWN)||Maybe(function(){a.move(DIRECTION.RIGHT),b.move(DIRECTION.RIGHT)},1-a.gameObject.canBePushed.friction))),Input.isLeft()&&(a=this.getObject(DIRECTION.LEFT),a.gameObject.canBePushed&&a.gameObject.canBePushed.horizontal&&(this.animate(ANIMATION.PUSH_LEFT),!a.canMove(DIRECTION.LEFT)||a.gameObject.canFall&&a.canMove(DIRECTION.DOWN)||Maybe(function(){a.move(DIRECTION.LEFT),b.move(DIRECTION.LEFT)},1-a.gameObject.canBePushed.friction))),Input.isUp()&&(a=this.getObject(DIRECTION.UP),a.gameObject.canBePushed&&a.gameObject.canBePushed.vertical&&(this.animate(ANIMATION.PUSH_UP),a.canMove(DIRECTION.UP)&&Maybe(function(){a.move(DIRECTION.UP),b.move(DIRECTION.UP)},1-a.gameObject.canBePushed.friction))),Input.isDown()&&(a=this.getObject(DIRECTION.DOWN),a.gameObject.canBePushed&&a.gameObject.canBePushed.vertical&&(this.animate(ANIMATION.PUSH_DOWN),a.canMove(DIRECTION.DOWN)&&Maybe(function(){a.move(DIRECTION.DOWN),b.move(DIRECTION.DOWN)},1-a.gameObject.canBePushed.friction))))}else if(c.canFall&&this.moveIfPossible(DIRECTION.DOWN),!this.isMoving()&&!this.wasMoving()&&c.canFall&&!this.getObject(DIRECTION.DOWN).gameObject.isStableSurface){var i=this.canMove(DIRECTION.LEFTDOWN),j=this.canMove(DIRECTION.RIGHTDOWN);i&&j&&this.move(Game.getRandomHorizontalDirection()),this.isMoving()||(i&&this.move(DIRECTION.LEFT),j&&this.move(DIRECTION.RIGHT))}this.wasMoving()&&!this.isMoving()&&this.wasMovingToDirection==DIRECTION.DOWN&&(a=this.getObject(DIRECTION.DOWN),c.onFallen&&c.onFallen(this,a),a.gameObject.onHit&&a.gameObject.onHit(this,DIRECTION.DOWN,a)),c.eachStep&&c.eachStep(this),this.isMoving()&&!c.isPlayer()&&(a=this.getObject(this.moveDirection),a.gameObject.onCollected&&!a.isMoving()&&a.gameObject.onCollected(c,a,this.moveDirection)),this.processed=!0
}}},MapPosition.prototype.fullStep=function(a){if(this.next){for(var b in this.next)this[b]=this.next[b];this.gameObject=GameObjects[this.id],this.staticFrame=this.gameObject.getStaticFrame(),this.wasMovingToDirection=this.movingInToDirection,this.id==GameObjects.PLAYER.id&&this.mapLayer.setPlayerObject(this),this.animation=!1}else this.wasMovingToDirection=void 0;this.animation&&(this.animation.length>this.animationStartFrame+a+1?this.animationStartFrame=this.animationStartFrame+a+1:this.animation=!1),this.reset(),this.action&&(this.action(this),this.action=void 0)},MapPosition.prototype.reset=function(){this.moveDirection=void 0,this.next=void 0,this.movingInToDirection=void 0,this.processed=!1},MapPosition.prototype.setNext=function(a,b){this.next=this.next||{},this.next[a]=b},MapPosition.prototype.getObject=function(a){var b=this.mapLayer.levelWidth,c=this.mapLayer.objects;switch(a){case DIRECTION.DOWN:return c[this.index+b];case DIRECTION.UP:return c[this.index-b];case DIRECTION.LEFT:return c[this.index-1];case DIRECTION.RIGHT:return c[this.index+1];case DIRECTION.LEFTDOWN:return c[this.index-1+b];case DIRECTION.RIGHTDOWN:return c[this.index+1+b];case DIRECTION.LEFTUP:return c[this.index-1-b];case DIRECTION.RIGHTUP:return c[this.index+1-b];case DIRECTION.NONE:return c[this.index]}},MapPosition.prototype.canMove=function(a){if(this.isMoving())return!1;var b;if(a>100){if(a==DIRECTION.LEFTDOWN){var c=this.getObject(DIRECTION.LEFT),d=this.getObject(DIRECTION.LEFTDOWN);if(c.next||d.next)return!1;if(this.gameObject.canMoveTo(c,DIRECTION.LEFT)&&this.gameObject.canMoveTo(d,DIRECTION.DOWN))return!0}if(a==DIRECTION.RIGHTDOWN){var e=this.getObject(DIRECTION.RIGHT),d=this.getObject(DIRECTION.RIGHTDOWN);if(e.next||d.next)return!1;if(this.gameObject.canMoveTo(e,DIRECTION.RIGHT)&&this.gameObject.canMoveTo(d,DIRECTION.DOWN))return!0}}else if(b=this.getObject(a)){if(b.next&&b.next.id)return!1;if(this.gameObject.canMoveTo(b,a))return!0}return!1},MapPosition.prototype.canMoveLeft=function(){return this.canMove(DIRECTION.LEFT)},MapPosition.prototype.canMoveRight=function(){return this.canMove(DIRECTION.RIGHT)},MapPosition.prototype.canMoveUp=function(){return this.canMove(DIRECTION.UP)},MapPosition.prototype.canMoveDown=function(){return this.canMove(DIRECTION.DOWN)},MapPosition.prototype.isMoving=function(){return!!this.moveDirection},MapPosition.prototype.wasMoving=function(){return!!this.wasMovingToDirection},MapPosition.prototype.sameDirection=function(){return this.wasMovingToDirection},MapPosition.prototype.move=function(a){this.moveDirection=a;var b=this.nextObjectId||0;this.setNext("id",b),this.nextObjectId=void 0,this.animate(a),this.onMove&&(this.onMove(this),this.onMove=void 0);var c=this.getObject(a);return c.setNext("id",this.id),c.setNext("_objectProperties",this._objectProperties),c.movingInToDirection=a,c},MapPosition.prototype.moveIfPossible=function(a){return this.canMove(a)?this.move(a):!1},MapPosition.prototype.moveLeftIfPossible=function(){this.moveIfPossible(DIRECTION.LEFT)},MapPosition.prototype.moveRightIfPossible=function(){this.moveIfPossible(DIRECTION.RIGHT)},MapPosition.prototype.moveUpIfPossible=function(){this.moveIfPossible(DIRECTION.UP)},MapPosition.prototype.moveDownIfPossible=function(){this.moveIfPossible(DIRECTION.DOWN)},MapPosition.prototype.animate=function(a){"string"==typeof a||"number"==typeof a?(this.animation=this.gameObject[a],this.animation||(this.animation=this.gameObject["animation"+a]),this.animation||(this.animation=this.gameObject.animationFrames[a]),this.animation||(this.animation=this.gameObject.animationFrames["animation"+a])):this.animation=a,this.animationStartFrame=0},MapPosition.prototype.zapIfPossible=function(a){var b=!1;return this.canMove(a)&&(b=this.getObject(a)),b},MapPosition.prototype.animateIfPossible=function(a){this.isAnimating()||this.animate(a)},MapPosition.prototype.isAnimating=function(){return this.animation},MapPosition.prototype.isNextTo=function(a){var b=this.getObject(DIRECTION.LEFT).gameObject.id,c=this.getObject(DIRECTION.RIGHT).gameObject.id,d=this.getObject(DIRECTION.DOWN).gameObject.id,e=this.getObject(DIRECTION.UP).gameObject.id,f=a.id;return b==f||e==f||c==f||d==f},MapPosition.prototype.isGameObject=function(a){return this.gameObject.id==a.id},MapPosition.prototype.refresh=function(){this.setNext("id",this.id)},MapPosition.prototype.transformInto=function(a,b,c){this.setNext("id",a.id),b&&this.animate(b),c&&this.setNext("action",c)},MapPosition.prototype.addLayer=function(a,b){if("bottom"==b){this.bottomlayer=a;var c=Map.getLayer("bottom");c||(c=Map.addLayer({id:"bottom",zIndex:0,type:MAPLAYERTYPE.SPOT,parentLayer:this.mapLayer}),Map.sortLayers());var d=new MapPosition(this.gameObject,this.index,c);c.addObject(d,MAPOBJECTTYPE.GRID)}else this.toplayer=a},MapPosition.prototype.removeLayer=function(a){if("bottom"==a){this.bottomlayer=void 0;var b=Map.getLayer("bottom");b&&b.removeObject(this)}else this.toplayer=void 0},MapPosition.prototype.hasLayer=function(a){return"bottom"==a?void 0!=this.bottomlayer:void 0!=this.toplayer},MapPosition.prototype.objectProperties=function(){return this._objectProperties=this._objectProperties||{}},MapPosition.prototype.getExplodeIntoObjects=function(){var a=Game.getSettings().defaultGameObject;return this.gameObject.explodeIntoObjects&&(a=this.gameObject.explodeIntoObjects()),this.gameObject.explodeIntoObject&&(a=this.gameObject.explodeIntoObject),a},UI.Button=function(a){var b=this;for(var c in a)this[c]=a[c];this.image=new Image,this.image.onload=function(){isDefined(b.width)||(b.width=this.width),isDefined(b.height)||(b.height=this.height),b.states||(b.states=[[0,0,b.width,b.height]]),isDefined(b.initialState)||(b.initialState=0),b.state=b.states[b.initialState],b.imageLoaded=!0,b.setPosition()},this.image.src=this.url},UI.Button.prototype.setSate=function(a){this.state=this.states[a]},UI.Button.prototype.setPosition=function(){isDefined(this.left)||(this.left=this.right-this.width),isDefined(this.right)||(this.right=this.left+this.width),isDefined(this.top)||(this.top=this.bottom-this.height),isDefined(this.bottom)||(this.bottom=this.top+this.height)},UI.Button.prototype.render=function(){this.imageLoaded&&(ctx.drawImage(this.image,this.state[0],this.state[1],this.state[2],this.state[3],this.left,this.top,this.width,this.height),UI.registerEventElement(this,this.left,this.top,this.right,this.bottom))},UI.GameController=function(a){var b=this;this.sprites=[],this.state=0,this.image=new Image,this.image.onload=function(){b.tileSize=this.height;for(var a=0;5>a;a++){var c=new Sprite(this,a,b.tileSize);b.sprites.push(c)}b.imageLoaded=!0,b.setPosition()},this.image.src=a.image,this.onDown=function(a){d(a.x,a.y)},this.onDrag=function(a){d(a.x,a.y)},this.onUp=function(){c()};var c=function(){b.state=DIRECTION.NONE,Input.isLeft(!1),Input.isRight(!1),4==a.input&&(Input.isUp(!1),Input.isDown(!1))},d=function(d,e){c(),d-=b.left,e-=b.top;var f=16,g=b.tileSize/2;g-f>d&&(Input.isLeft(!0),b.state=DIRECTION.LEFT),d>g+f&&(Input.isRight(!0),b.state=DIRECTION.RIGHT),4==a.input&&(g-f>e&&(Input.isUp(!0),b.state=DIRECTION.UP),e>g+f&&(Input.isDown(!0),b.state=DIRECTION.DOWN))}},UI.GameController.prototype.setPosition=function(){this.top=canvas.height-150,this.left=10,this.right=this.left+this.tileSize,this.bottom=this.top+this.tileSize},UI.GameController.prototype.render=function(){if(this.imageLoaded){var a=Math.max(this.state-DIRECTION.LEFT+1,0);ctx.drawImage(this.sprites[a].canvas,this.left,this.top),UI.registerEventElement(this,this.left,this.top,this.right,this.bottom)}},UI.Listbox=function(a){function b(a){return a>d.minScollPosition&&(a=d.minScollPosition),0-d.maxScrollPosition>a&&(a=0-d.maxScrollPosition),a}function c(a,b){return(a?0>a?-1:1:0)==(b?0>b?-1:1:0)}var d=this;this.items=a.items,this.onSelect=a.onSelect,this.onResize=a.onResize,this.scrollOffetY=a.scrollY||0,this.scrollDeltaY=0,this.scrollSpeed=0,this.scrollElastic=0,this.scrollHistory=[],this.scrollThreshold=5,this.itemHeight=a.itemHeight||64,this.top=a.top,this.left=a.left||100,this.width=a.width||400,this.height=a.height||400,this.minScollPosition=0,this.maxScrollPosition=this.items.length*this.itemHeight-this.height,this.preserveState=a.preserveState||function(){};for(var e=function(a){var b=a.y-a.startY;d.scrollDeltaY=parseInt(b)},f=function(a){if(Math.abs(d.scrollDeltaY)<d.scrollThreshold)d.onSelect(a.UIobject.element);else{d.scrollElastic=20;var b=0-h()/10,c=d.scrollOffetY+d.scrollDeltaY,e=(1+d.scrollElastic)*d.scrollElastic/2,f=c+e*b;f>d.minScollPosition&&(b=d.minScollPosition-c/e,f=d.minScollPosition),0-d.maxScrollPosition>f&&(b=(0-c-d.maxScrollPosition)/e,f=0-d.maxScrollPosition),d.preserveState("scrollY",f),d.scrollSpeed=b}d.scrollOffetY+=d.scrollDeltaY,d.scrollDeltaY=0,d.scrollHistory=[]},g=function(a){var c=b(d.scrollOffetY+a/3);d.scrollOffetY=c},h=function(){var a=0,b=d.scrollHistory;if(b.length>0){var e,f=0,g=[];for(e=0;b.length>e;e++){var h=b[e];if(0==h)g.push(h);else{if(0==f&&(f=h),!c(f,h))break;g.push(h)}}if(g.length>0){var i=0;for(e=0;g.length>e;e++)i+=g[e];a=i/g.length}return a}},i=0,j=this.items.length;j>i;i++)this.items[i].onUp=f,this.items[i].onDrag=e,this.items[i].onMouseWheel=g},UI.Listbox.prototype.render=function(){function a(a){b+=d;var h=sprites[a.icon].canvas;ctx.fillStyle="Black",ctx.clearRect(c,b+f,e,g),ctx.drawImage(h,c,b),ctx.fillStyle="Grey",ctx.font="normal 10pt Arial",ctx.fillText(a.name,c+40,b+16),UI.registerEventElement(a,c,b,c+e,b+d)}this.scrollOffetY=this.scrollOffetY+this.scrollElastic*this.scrollSpeed;var b=this.top+this.scrollOffetY+this.scrollDeltaY,c=this.left,d=this.itemHeight,e=this.width,f=d-10,g=.5;this.scrollElastic>0&&(this.scrollElastic-=1),this.prevScrollDeltaY=this.prevScrollDeltaY||0;var h=this.prevScrollDeltaY-this.scrollDeltaY;this.scrollHistory.unshift(h),this.scrollHistory.length>10&&this.scrollHistory.pop(),this.prevScrollDeltaY=this.scrollDeltaY;for(var i=0,j=this.items.length;j>i;i++)a(this.items[i])};